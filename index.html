<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SbaHub - Modern School Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/heroicons@2.0.18/24/outline/index.js"></script>
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .glass { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .page-content { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #scores-page .card, #settings-page .card, #manage-students-page .card, #reports-page .card { background: #ffffff; border-radius: 12px; padding:16px; box-shadow: 0 6px 18px rgba(17,24,39,0.06); }
        #scores-page .grid-2{display:grid;grid-template-columns:380px 1fr;gap:16px}
        @media (max-width:900px){ #scores-page .grid-2{grid-template-columns:1fr;} }
        .form .field{display: flex; flex-direction:column; margin-bottom:8px}
        .form .field label{font-size:13px;color: #6b7280; margin-bottom:6px}
        .form .field input, .form .field select {padding:10px; border-radius:8px; border:1px solid #e6edf3}
        /* Ensure all common input types, selects and textareas have visible borders */
        input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="tel"], input[type="file"], input[type="date"], textarea, select {
            border: 1px solid #94a3b8; /* slightly stronger visible gray */
            padding: 10px;
            border-radius: 8px;
            background-color: #fff;
            color: #0f172a;
            outline: none;
        }
        /* Tweak date input appearance across browsers */
        input[type="date"] {
            -webkit-appearance: none;
            -moz-appearance: textfield;
            appearance: none;
            background-image: none; /* hide native calendar icon if needed */
        }
        /* Inputs inside dark modals should have lighter borders for contrast */
        #auth-container input, #auth-container select, #auth-container textarea,
        .glass input, .glass select, .glass textarea {
            border-color: rgba(255,255,255,0.25);
        }
        .btn{padding:8px 12px; border-radius:8px; border:1px solid #d1d5db;background:white; cursor:pointer}
        .btn.primary{background: #3b82f6; border:0;color:white}
        #scores-page .table-wrap, #manage-students-page .table-wrap {overflow:auto; max-height:420px}
        table{width:100%;border-collapse:collapse;font-size:13px}
        thead th{position:sticky;top:0;background: #f8fafc;z-index:1;padding: 10px; border-bottom:1px solid #eef2f6;text-align:left;}
        td{padding:10px; border-bottom:1px solid #f1f5f9;text-align:left}
        .plan-card.selected { border-color: #7c3aed; box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.3); }
        .sidebar .nav-link.active { background-color: rgba(255, 255, 255, 0.2); font-weight: 600; }
        @media print { body * { visibility: hidden; } #raw-score-sheet-container, #raw-score-sheet-container * { visibility: visible; } #raw-score-sheet-container { position: absolute; left: 0; top: 0; width: 100%; } }
    </style>
</head>
<body class="bg-gray-50 text-slate-800">

    <div id="public-container">
        <header class="bg-white shadow-sm fixed w-full z-40">
            <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"><div class="flex justify-between h-16 items-center"><div class="gradient-bg text-white px-4 py-2 rounded-lg font-bold text-xl">SbaHub</div><div class="hidden md:flex space-x-8"><a href="#home" class="text-gray-700 hover:text-purple-600 font-medium">Home</a><a href="#features" class="text-gray-700 hover:text-purple-600 font-medium">Features</a><a href="#updates" class="text-gray-700 hover:text-purple-600 font-medium">Updates</a><a href="#pricing" class="text-gray-700 hover:text-purple-600 font-medium">Pricing</a></div><a href="#" onclick="showLogin()" class="gradient-bg text-white px-6 py-2 rounded-lg font-semibold hover:opacity-90 transition">Login</a></div></nav>
        </header>

        <main>
            <section id="home" class="gradient-bg text-white pt-32 pb-20"><div class="max-w-7xl mx-auto px-4 text-center"><h1 class="text-5xl md:text-6xl font-bold mb-6">Modern Student Base Assessment, Simplified</h1><p class="text-xl mb-8 max-w-3xl mx-auto text-purple-100">Streamline assessments, generate beautiful report cards, and manage school data all in one place.</p><a href="#" onclick="showSignUp()" class="bg-white text-purple-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition">Get Started For Free</a></div></section>
            <section id="features" class="py-20 bg-gray-50"><div class="max-w-7xl mx-auto px-4 text-center"><h2 class="text-4xl font-bold mb-4">Powerful Features</h2><p class="text-xl text-gray-600 mb-12">Everything you need to manage your school assessment effectively.</p><div class="grid md:grid-cols-3 gap-8"><div class="bg-white p-8 rounded-xl shadow-md transition transform hover:-translate-y-2 hover:shadow-xl"><h3 class="text-2xl font-bold mb-3">Automated Scoring</h3><p class="text-gray-600">Enter CAT and Exam scores, and let SbaHub automatically calculate scaled totals, ranks, and grades.</p></div><div class="bg-white p-8 rounded-xl shadow-md transition transform hover:-translate-y-2 hover:shadow-xl"><h3 class="text-2xl font-bold mb-3">Custom Reports</h3><p class="text-gray-600">Generate professional PDF report cards using modern templates, complete with school crests and signatures.</p></div><div class="bg-white p-8 rounded-xl shadow-md transition transform hover:-translate-y-2 hover:shadow-xl"><h3 class="text-2xl font-bold mb-3">Bulk Data Upload</h3><p class="text-gray-600">Easily upload all student scores for a subject at once using a simple Excel template.</p></div></div></div></section>
            
            <section id="updates" class="py-20">
                <div class="max-w-7xl mx-auto px-4 text-center">
                    <h2 class="text-4xl font-bold mb-4">Latest System Updates</h2>
                    <p class="text-xl text-gray-600 mb-12">Stay informed about new features and upcoming improvements.</p>
                    <div id="public-announcements-list" class="grid md:grid-cols-2 gap-8 text-left max-w-4xl mx-auto">
                        </div>
                </div>
            </section>

            <section id="pricing" class="py-20 bg-gray-50">
                <div class="max-w-7xl mx-auto px-4 text-center">
                    <h2 class="text-4xl font-bold mb-4">Simple, Transparent Pricing</h2>
                    <p class="text-xl text-gray-600 mb-12">Choose the plan that's right for your institution.</p>
                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                        
                        <div class="bg-white p-8 rounded-xl shadow-lg border">
                            <h3 class="text-2xl font-bold">Demo</h3>
                            <p class="text-4xl font-bold my-4">Free</p>
                            <ul class="space-y-2 text-gray-600 text-left">
                                <li>✓ 1 School</li>
                                <li>✓ 1 Class</li>
                                <li>✓ 1 Student</li>
                                <li>✓ Add Headteacher Signature</li>
                                <li>✓ Preview Reports</li>
                                <li class="text-gray-400">✗ Download Reports</li>
                            </ul>
                            <button onclick="showSignUp()" class="mt-8 w-full py-3 px-4 border border-purple-600 text-purple-600 rounded-lg hover:bg-purple-600 hover:text-white transition">Get Started</button>
                        </div>
                        
                        <div class="bg-white p-8 rounded-xl shadow-lg border">
                            <h3 class="text-2xl font-bold">Basic</h3>
                            <p class="text-4xl font-bold my-4">GHS 50<span class="text-lg font-medium text-gray-500">/year</span></p>
                            <ul class="space-y-2 text-gray-600 text-left">
                                <li>✓ Unlimited Schools</li>
                                <li>✓ Unlimited Classes</li>
                                <li>✓ Bulk Add Students</li>
                                <li>✓ Add Headteacher Signature</li>
                                <li>✓ Generate All Reports</li>
                                <li>✓ Download All Reports</li>
                            </ul>
                            <button onclick="showSignUp()" class="mt-8 w-full py-3 px-4 border border-purple-600 text-purple-600 rounded-lg hover:bg-purple-600 hover:text-white transition">Choose Plan</button>
                        </div>
                        
                        <div class="bg-white p-8 rounded-xl shadow-2xl border-2 border-purple-600 relative">
                            <span class="absolute top-0 -translate-y-1/2 bg-purple-600 text-white text-xs font-bold px-3 py-1 rounded-full uppercase">Most Popular</span>
                            <h3 class="text-2xl font-bold">Pro</h3>
                            <p class="text-4xl font-bold my-4">GHS 100<span class="text-lg font-medium text-gray-500">/year</span></p>
                            <ul class="space-y-2 text-gray-600 text-left">
                                <li>✓ Everything in Basic</li>
                                <li>✓ Upload School Logo/Crest</li>
                                <li>✓ Excel Template Upload</li>
                                <li>✓ Excel Data Download</li>
                            </ul>
                            <button onclick="showSignUp()" class="mt-8 w-full py-3 px-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">Choose Plan</button>
                        </div>
                        
                        <div class="bg-white p-8 rounded-xl shadow-lg border">
                            <h3 class="text-2xl font-bold">Pro Plus</h3>
                            <p class="text-4xl font-bold my-4">GHS 150<span class="text-lg font-medium text-gray-500">/year</span></p>
                            <ul class="space-y-2 text-gray-600 text-left">
                                <li>✓ Everything in Pro</li>
                                <li>✓ Add Student Pictures</li>
                                <li>✓ Use Crest as Watermark</li>
                            </ul>
                            <button onclick="showSignUp()" class="mt-8 w-full py-3 px-4 border border-purple-600 text-purple-600 rounded-lg hover:bg-purple-600 hover:text-white transition">Choose Plan</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="bg-gray-800 text-white py-12 px-4">
            <div class="max-w-7xl mx-auto grid md:grid-cols-4 gap-8">
                <div>
                    <div class="gradient-bg text-white px-4 py-2 rounded-lg font-bold text-xl inline-block mb-4">SbaHub</div>
                    <p class="text-gray-400">Modern school management made simple and efficient.</p>
                </div>
                <div>
                    <h4 class="font-semibold mb-4">Product</h4>
                    <ul class="space-y-2 text-gray-400">
                        <li><a href="#features" class="hover:text-white transition">Features</a></li>
                        <li><a href="#pricing" class="hover:text-white transition">Pricing</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold mb-4">Company</h4>
                    <ul class="space-y-2 text-gray-400">
                        <li><a href="#" class="hover:text-white transition">About Us</a></li>
                        <li><a href="#" class="hover:text-white transition">Contact</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold mb-4">Support</h4>
                    <ul class="space-y-2 text-gray-400">
                        <li><a href="#" class="hover:text-white transition">Help Center</a></li>
                        <li><a href="#" onclick="showLogin()" class="hover:text-white transition">Login</a></li>
                    </ul>
                </div>
            </div>
            <div class="max-w-7xl mx-auto mt-8 pt-8 border-t border-gray-700 text-center text-gray-400">
                <p>&copy; 2025 SbaHub. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <div id="auth-container" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm">
        <div id="login-page"><div class="w-full max-w-md p-8 space-y-6 glass rounded-2xl shadow-lg relative"><button onclick="hideAuthModals()" class="absolute top-4 right-4 text-slate-300 hover:text-white text-3xl">&times;</button><h1 class="text-3xl font-bold text-white text-center">Welcome Back</h1><form class="space-y-6" onsubmit="event.preventDefault()"><div><label class="text-sm font-medium text-slate-200">Email Address</label><input type="email" id="login-email" required class="mt-1 block w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg text-white"></div><div><label class="text-sm font-medium text-slate-200">Password</label><input type="password" required class="mt-1 block w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg text-white"></div><div class="flex flex-col gap-4 pt-2"><button type="button" onclick="login('school_user')" class="w-full py-3 px-4 rounded-lg text-purple-600 bg-white hover:bg-gray-100 font-semibold">Sign in as School User</button><button type="button" onclick="login('system_admin')" class="w-full py-3 px-4 rounded-lg text-white bg-white/10 hover:bg-white/20 font-semibold border border-white/30">Sign in as System Admin</button></div><p class="text-sm text-center text-slate-300">Don't have an account? <a href="#" onclick="showSignUp(event)" class="font-medium text-purple-300 hover:text-purple-200">Sign Up</a></p></form></div></div>
        <div id="signup-page" class="hidden"><div class="w-full max-w-md p-8 space-y-6 glass rounded-2xl shadow-lg relative"><button onclick="hideAuthModals()" class="absolute top-4 right-4 text-slate-300 hover:text-white text-3xl">&times;</button><h1 class="text-3xl font-bold text-white text-center">Create Your Account</h1><form class="space-y-4" onsubmit="event.preventDefault()"><div><label class="text-sm font-medium text-slate-200">Full Name</label><input type="text" required class="mt-1 block w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg text-white"></div><div><label class="text-sm font-medium text-slate-200">Email Address</label><input type="email" id="signup-email" required class="mt-1 block w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg text-white"></div><div><label class="text-sm font-medium text-slate-200">Password</label><input type="password" required class="mt-1 block w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg text-white"></div><div class="pt-2"><button type="button" onclick="handleSignup()" class="w-full py-3 px-4 rounded-lg text-purple-600 bg-white hover:bg-gray-100 font-semibold">Create Account</button></div><p class="text-sm text-center text-slate-300">Already have an account? <a href="#" onclick="showLogin(event)" class="font-medium text-purple-300 hover:text-purple-200">Login</a></p></form></div></div>
    </div>

    <div id="app-container" class="hidden">
        <aside class="sidebar gradient-bg text-purple-100 w-64 fixed inset-y-0 left-0 z-30 transform lg:translate-x-0 flex flex-col"><div class="flex items-center justify-center h-16 border-b border-white/20"><div class="bg-white/20 text-white px-4 py-2 rounded-lg font-bold text-lg">SbaHub</div></div><nav id="nav-container" class="flex-1 px-4 py-6 space-y-2"></nav><div class="px-4 py-4 border-t border-white/20"><a href="#" onclick="logout()" class="flex items-center gap-3 w-full px-4 py-2 text-sm rounded-lg hover:bg-white/20"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>Logout</a></div></aside>
        <div class="lg:pl-64 flex flex-col flex-1 min-h-screen">
            <header class="sticky top-0 z-10 flex items-center justify-between h-16 px-8 bg-white/80 backdrop-blur-sm border-b"><h1 id="page-title" class="text-xl font-semibold">Dashboard</h1></header>
            <main id="main-content" class="flex-1 p-8">
                <div id="dashboard-page" class="page-content hidden"></div>
                <div id="schools-page" class="page-content hidden"></div>
                <div id="settings-page" class="page-content hidden"></div>
                <div id="manage-students-page" class="page-content hidden"></div>
                <div id="scores-page" class="page-content hidden"></div>
                <div id="reports-page" class="page-content hidden"></div>
                <div id="subscribe-page" class="page-content hidden"></div>
                <div id="user-profile-page" class="page-content hidden"></div>
                <div id="admin-dashboard-page" class="page-content hidden"></div>
                <div id="admin-manage-users-page" class="page-content hidden"></div>
                <div id="admin-settings-page" class="page-content hidden"></div>
                <div id="admin-analytics-page" class="page-content hidden"></div>
            </main>
        </div>
    </div>
    
    <div id="school-type-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
        <div class="bg-white w-full max-w-md rounded-lg shadow-lg">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-lg font-bold">Select School Type</h2>
                <button onclick="hideSchoolTypeModal()" class="text-2xl">&times;</button>
            </div>
            <div class="p-8 flex flex-col gap-4">
                 <p class="text-center text-gray-600 mb-4">Is this a private or a public institution?</p>
                <button onclick="showSchoolForm('Private')" class="w-full py-3 px-4 rounded-lg text-white gradient-bg hover:opacity-90 font-semibold">Private School</button>
                <button onclick="showSchoolForm('Public')" class="w-full py-3 px-4 rounded-lg text-purple-600 bg-purple-100 hover:bg-purple-200 font-semibold">Public School</button>
            </div>
        </div>
    </div>

    <div id="report-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4"><div class="bg-white w-full max-w-4xl rounded-lg shadow-lg max-h-[95vh] flex flex-col"><div class="p-4 border-b flex justify-between items-center"><h2 class="text-lg font-bold">Student Report Card</h2><button onclick="document.getElementById('report-modal').classList.add('hidden')" class="text-2xl">&times;</button></div><div id="report-card-content" class="p-6 overflow-y-auto"></div><div class="p-4 border-t flex justify-end gap-4"><button onclick="document.getElementById('report-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-200 rounded-lg">Close</button><button onclick="downloadReportAsPDF()" class="px-4 py-2 text-white gradient-bg rounded-lg">Download as PDF</button></div></div></div>
    
    <div id="school-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4"><div class="bg-white w-full max-w-2xl rounded-lg shadow-lg max-h-[95vh] flex flex-col"><div class="p-4 border-b flex justify-between items-center"><h2 id="school-modal-title" class="text-lg font-bold">Create New School</h2><button onclick="hideSchoolModal()" class="text-2xl">&times;</button></div><div class="p-6 overflow-y-auto"><form id="school-form" class="space-y-4">
        <input type="hidden" name="schoolId">
        <div><label class="text-sm">School Name</label><input name="name" type="text" required class="w-full p-2 border rounded mt-1"></div><div><label class="text-sm">Address</label><input name="address" type="text" class="w-full p-2 border rounded mt-1"></div>
        <div>
            <label class="text-sm">Select Classes</label>
            <div id="class-selection-container" class="mt-2 p-3 border rounded-lg max-h-48 overflow-y-auto grid grid-cols-2 md:grid-cols-4 gap-2">
            </div>
        </div>
        <div class="pt-4 flex justify-end"><button id="school-form-submit-btn" type="submit" class="px-4 py-2 text-white gradient-bg rounded-lg">Save School</button></div></form></div></div></div>

    <div id="student-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
        <div class="bg-white w-full max-w-lg rounded-lg shadow-lg">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 id="student-modal-title" class="text-lg font-bold">Add New Student</h2>
                <button onclick="hideStudentModal()" class="text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <form id="student-form" class="space-y-4">
                    <input type="hidden" name="studentId">
                    <div>
                        <label class="text-sm">Full Name</label>
                        <input name="name" type="text" required class="w-full p-2 border rounded mt-1">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm">School</label>
                            <select name="schoolId" required class="w-full p-2 border rounded mt-1"></select>
                        </div>
                        <div>
                            <label class="text-sm">Class</label>
                            <select name="className" required class="w-full p-2 border rounded mt-1" disabled></select>
                        </div>
                    </div>
                    <div id="student-picture-upload-field">
                        <label class="text-sm">Student Picture (Pro Feature)</label>
                        <input name="pictureFile" type="file" accept="image/*" class="w-full text-sm">
                        <img id="student-picture-preview" src="" class="hidden mt-2 h-24 w-24 object-cover rounded">
                    </div>
                    <div class="pt-4 flex justify-end">
                        <button type="submit" class="px-4 py-2 text-white gradient-bg rounded-lg">Save Student</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
        <div class="bg-white w-full max-w-sm rounded-lg shadow-lg">
            <div class="p-6">
                <h3 class="text-lg font-semibold mb-2">Confirm Action</h3>
                <p id="confirmation-message" class="text-sm text-gray-600 mb-6"></p>
                <div class="flex justify-end gap-4">
                    <button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-lg text-sm font-medium">Cancel</button>
                    <button id="confirm-action-btn" class="px-4 py-2 text-white bg-red-600 rounded-lg text-sm font-medium">Delete</button>
                </div>
            </div>
        </div>
    </div>

     <div id="bulk-download-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
        <div class="bg-white w-full max-w-lg rounded-lg shadow-lg">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-lg font-bold">Bulk Download Reports</h2>
                <button onclick="hideBulkDownloadModal()" class="text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <form id="bulk-download-form" class="space-y-4">
                    <div class="field">
                        <label>Select School</label>
                        <select id="bulk-school-select" class="w-full p-2 border rounded mt-1" required></select>
                    </div>
                    <div class="field">
                        <label>Select Class</label>
                        <select id="bulk-class-select" class="w-full p-2 border rounded mt-1" disabled required></select>
                    </div>
                    <div class="field">
                        <label>Select Report Layout</label>
                        <select id="bulk-layout-select" class="w-full p-2 border rounded mt-1" required>
                            <option value="1">Layout 1</option>
                            <option value="2">Layout 2</option>
                        </select>
                    </div>
                    <div class="pt-4 flex justify-end">
                        <button type="submit" class="px-4 py-2 text-white gradient-bg rounded-lg">Download PDF</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="bulk-student-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
        <div class="bg-white w-full max-w-lg rounded-lg shadow-lg">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-lg font-bold">Bulk Add Students</h2>
                <button onclick="hideBulkStudentModal()" class="text-2xl">&times;</button>
            </div>
            
            <div class="border-b border-gray-200">
                <nav class="flex -mb-px">
                    <button type="button" onclick="switchBulkAddTab(this, 'manual')" class="bulk-add-tab py-3 px-4 text-sm font-medium text-center text-purple-600 border-b-2 border-purple-600">
                        Add Manually
                    </button>
                    <button type="button" onclick="switchBulkAddTab(this, 'excel')" class="bulk-add-tab py-3 px-4 text-sm font-medium text-center text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300">
                        Add from Excel
                    </button>
                </nav>
            </div>
            
            <div id="bulk-add-manual" class="bulk-add-tab-content p-6">
                <form id="bulk-student-form" onsubmit="handleBulkAddStudents(event)" class="space-y-4">
                    <p class="text-sm text-gray-600">Enter one student name per line. They will be added to the currently selected school and class.</p>
                    <textarea name="studentNames" rows="8" class="w-full p-2 border rounded mt-1" placeholder="Student Name 1
Student Name 2
Student Name 3" required></textarea>
                    <div class="pt-4 flex justify-end">
                        <button type="submit" class="px-4 py-2 text-white gradient-bg rounded-lg">Add Students</button>
                    </div>
                </form>
            </div>
            
            <div id="bulk-add-excel" class="bulk-add-tab-content p-6 hidden space-y-6">
                <div>
                    <h3 class="font-semibold text-gray-800">Step 1: Download Template</h3>
                    <p class="text-sm text-gray-600 mb-2">Download the Excel template. Add your student names to the 'Student Name' column.</p>
                    <button type="button" onclick="downloadStudentTemplate()" class="btn primary w-full">Download Student Template (.xlsx)</button>
                </div>
                <div class="border-t pt-6">
                    <h3 class="font-semibold text-gray-800">Step 2: Upload Completed Template</h3>
                    <p class="text-sm text-gray-600 mb-2">Upload the same template file after you have filled it with student names.</p>
                    <form id="bulk-student-upload-form" onsubmit="handleBulkStudentUpload(event)" class="space-y-4">
                        <input type="file" name="student_excel_file" class="w-full text-sm text-slate-500 file:mr-2 file:py-2 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100" required accept=".xlsx, .xls">
                        <div class="upload-status text-xs text-gray-500 mt-1"></div>
                        <div class="pt-4 flex justify-end">
                            <button type="submit" class="px-4 py-2 text-white gradient-bg rounded-lg">Upload and Add Students</button>
                        </div>
                    </form>
                </div>
            </div>
            
        </div>
    </div>
    <div id="toast-notification" class="hidden fixed bottom-5 right-5 bg-green-500 text-white py-3 px-5 rounded-lg shadow-lg transition-opacity duration-300">
        <p id="toast-message"></p>
    </div>

<script>
    // --- [App State and Configuration] ---
    const appState = {
        scores: [],
        students: [],
        schools: [],
        settings: {},
        announcements: [
            { title: 'System Maintenance Scheduled', content: 'The system will be down for scheduled maintenance this Friday at 10 PM.', type: 'info' },
            { title: 'New Report Card Layout', content: 'A new modern report card layout has been added. Check it out in the reports section.', type: 'success' }
        ],
        users: { // Only admin user exists initially
            "admin@sbahub.com": { role: "system_admin", plan: 'Admin', status: 'Active', studentCount: 0, createdAt: '2025-01-01', name: 'System Admin', pictureUrl: null }
        }
    };
    
    const classList = [
        'KG 1', 'KG 1A', 'KG 1B', 'KG 1C', 'KG 1D', 'KG 2', 'KG 2A', 'KG 2B', 'KG 2C', 'KG 2D',
        'BS 1', 'BS 1A', 'BS 1B', 'BS 1C', 'BS 1D', 'BS 2', 'BS 2A', 'BS 2B', 'BS 2C', 'BS 2D', 
        'BS 3', 'BS 3A', 'BS 3B', 'BS 3C', 'BS 3D', 'BS 4', 'BS 4A', 'BS 4B', 'BS 4C', 'BS 4D', 
        'BS 5', 'BS 5A', 'BS 5B', 'BS 5C', 'BS 5D', 'BS 6', 'BS 6A', 'BS 6B', 'BS 6C', 'BS 6D', 
        'BS 7', 'BS 7A', 'BS 7B', 'BS 7C', 'BS 7D', 'BS 8', 'BS 8A', 'BS 8B', 'BS 8C', 'BS 8D', 
        'BS 9', 'BS 9A', 'BS 9B', 'BS 9C', 'BS 9D'
    ];
    
    const subjectsByLevel = {
        'KG': ['Language and Literacy', 'Numeracy', 'Creative Arts', 'Writing', 'Our World Our People'],
        'BS1-3': ['English Language', 'Mathematics', 'Science', 'Ghanaian Language', 'Creative Art', 'Religious and Moral Education', 'History'],
        'BS4-6': ['English Language', 'Mathematics', 'Science', 'History', 'Creative Art', 'Computing', 'Religious and Moral Education', 'Ghanaian Language', 'Arabic', 'French'],
        'BS7-9': ['English Language', 'Mathematics', 'Integrated Science', 'Social Studies', 'Creative Arts', 'Computing', 'Ghanaian Language', 'Religious and Moral Education', 'French', 'Arabic']
    };

    const userNavLinks = [
        { name: 'Dashboard', pageId: 'dashboard-page', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg>' },
        { name: 'Manage School', pageId: 'schools-page', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" /></svg>' },
        { name: 'Setup School', pageId: 'settings-page', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-1.007 1.11-1.226l.28-.1c.34-.125.702-.125 1.042 0l.28.1c.548.219 1.02.684 1.11 1.226l.083.5c.09.528.523.936 1.03.996l.51.06c.47.053.89.28 1.17.654l.28.373c.372.498.372 1.246 0 1.744l-.28.373a1.34 1.34 0 01-1.17.654l-.51.06a1.25 1.25 0 00-1.03.996l-.083.5c-.09.542-.56 1.007-1.11 1.226l-.28.1c-.34.125-.702-.125-1.042 0l-.28-.1c-.548-.219-1.02-.684-1.11-1.226l-.083-.5a1.25 1.25 0 00-1.03-.996l-.51-.06a1.34 1.34 0 01-1.17-.654l-.28-.373c-.372-.498-.372-1.246 0 1.744l.28-.373c.28-.374.7-.601 1.17-.654l.51-.06c.507-.06.94-.468 1.03-.996l.083-.5z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>' },
        { name: 'Manage Students', pageId: 'manage-students-page', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-4.663M12 5.25a3.75 3.75 0 013.75 3.75s0 0 0 0-3.75 0-3.75-3.75zm0 0a3.75 3.75 0 00-3.75 3.75s0 0 0 0 3.75 0 3.75-3.75z" /></svg>' },
        { name: 'Assessment', pageId: 'scores-page', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>' },
        { name: 'Generate Reports', pageId: 'reports-page', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>' },
        { name: 'User Profile', pageId: 'user-profile-page', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>' },
        { name: 'Subscription', pageId: 'subscribe-page', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h6m3-5.25l-3.75 3.75m0 0l-3.75-3.75M14.25 19.5h4.5a2.25 2.25 0 002.25-2.25v-13.5a2.25 2.25 0 00-2.25-2.25h-13.5a2.25 2.25 0 00-2.25 2.25v4.5" /></svg>' }
    ];
    const adminNavLinks = [ { name: 'Dashboard', pageId: 'admin-dashboard-page', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg>' }, { name: 'Manage Users', pageId: 'admin-manage-users-page', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-4.663M12 5.25a3.75 3.75 0 013.75 3.75s0 0 0 0-3.75 0-3.75-3.75zm0 0a3.75 3.75 0 00-3.75 3.75s0 0 0 0 3.75 0 3.75-3.75z" /></svg>' }, { name: 'System Settings', pageId: 'admin-settings-page', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-1.007 1.11-1.226l.28-.1c.34-.125.702-.125 1.042 0l.28.1c.548.219 1.02.684 1.11 1.226l.083.5c.09.528.523.936 1.03.996l.51.06c.47.053.89.28 1.17.654l.28.373c.372.498.372 1.246 0 1.744l-.28.373a1.34 1.34 0 01-1.17.654l-.51.06a1.25 1.25 0 00-1.03.996l-.083.5c-.09.542-.56 1.007-1.11 1.226l-.28.1c-.34.125-.702-.125-1.042 0l-.28-.1c-.548-.219-1.02-.684-1.11-1.226l-.083-.5a1.25 1.25 0 00-1.03-.996l-.51-.06a1.34 1.34 0 01-1.17-.654l-.28-.373c-.372-.498-.372-1.246 0 1.744l.28-.373c.28-.374.7-.601 1.17-.654l.51-.06c.507-.06.94-.468 1.03-.996l.083-.5z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>' }, { name: 'Analytics', pageId: 'admin-analytics-page', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg>' }];

    // *** MODIFIED defaultSettings ***
    const defaultSettings = { 
        school_name: "", 
        school_tel: "", 
        postal_address: "", 
        term: "3", 
        year: "2025", 
        vacation_date: "", 
        reopening_date: "", 
        number_of_open_days: "", 
        grading_system: "1", 
        head_signature_url: null, 
        school_crest_url: null, 
        number_on_roll: "", 
        class_teacher_tel: "",
        report_layout: "1" // Added report layout setting
    };

    const pageContents = {
        'dashboard-page': `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6"><div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4"><div class="bg-blue-100 p-3 rounded-full"><svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></div><div><p class="text-sm text-gray-500">Total Students</p><p id="metric-total-students" class="text-2xl font-bold">0</p></div></div><div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4"><div class="bg-purple-100 p-3 rounded-full"><svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg></div><div><p class="text-sm text-gray-500">Total Schools</p><p id="metric-total-schools" class="text-2xl font-bold">0</p></div></div><div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4"><div class="bg-green-100 p-3 rounded-full"><svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div><div><p class="text-sm text-gray-500">Overall Average</p><p id="metric-average-score" class="text-2xl font-bold">0%</p></div></div><div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4"><div class="bg-yellow-100 p-3 rounded-full"><svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div><div><p class="text-sm text-gray-500">Subscription</p><p id="metric-subscription" class="text-2xl font-bold text-green-600">Pro</p></div></div></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md"><h3 class="text-lg font-semibold mb-4">Average Score Per Subject (All Schools)</h3><canvas id="subjectPerformanceChart"></canvas></div><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-lg font-semibold mb-4">Announcements from Admin</h3><div id="announcements-list" class="space-y-4"></div></div></div>
        
        <!-- NEW ROW ADDED HERE -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h3 class="text-lg font-semibold mb-4">Performance by School</h3>
                <canvas id="schoolPerformanceChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h3 class="text-lg font-semibold mb-4">School Summary</h3>
                <div class="overflow-x-auto" style="max-height: 300px;">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left text-gray-500">
                                <th class="py-2">School</th>
                                <th class="py-2">Avg. Score</th>
                                <th class="py-2">Best Subject</th>
                            </tr>
                        </thead>
                        <tbody id="school-summary-table">
                            <!-- Rows will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>`,
        'admin-dashboard-page': `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
    <div class="bg-white p-6 rounded-xl shadow-md"><p class="text-sm text-gray-500">Total Users</p><p id="admin-metric-total-users" class="text-3xl font-bold">0</p></div>
    <div class="bg-white p-6 rounded-xl shadow-md"><p class="text-sm text-gray-500">Active 'Demo' Plans</p><p id="admin-metric-demo-users" class="text-3xl font-bold text-yellow-500">0</p></div>
    <div class="bg-white p-6 rounded-xl shadow-md"><p class="text-sm text-gray-500">Active 'Basic' Plans</p><p id="admin-metric-basic-users" class="text-3xl font-bold text-blue-500">0</p></div>
    <div class="bg-white p-6 rounded-xl shadow-md"><p class="text-sm text-gray-500">Active 'Pro' Plans</p><p id="admin-metric-pro-users" class="text-3xl font-bold text-purple-600">0</p></div>
    <div class="bg-white p-6 rounded-xl shadow-md"><p class="text-sm text-gray-500">Active 'Pro Plus' Plans</p><p id="admin-metric-pro-plus-users" class="text-3xl font-bold text-indigo-600">0</p></div>
    <div class="bg-white p-6 rounded-xl shadow-md"><p class="text-sm text-gray-500">Inactive Accounts</p><p id="admin-metric-inactive-users" class="text-3xl font-bold text-red-600">0</p></div>
</div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-lg font-semibold mb-4">Recent User Signups</h3><div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="text-left text-gray-500"><th class="py-2">Email</th><th>Plan</th><th>Date & Time</th></tr></thead><tbody id="admin-recent-users-list"></tbody></table></div></div><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-lg font-semibold mb-4">Subscription Overview</h3><div class="max-w-xs mx-auto"><canvas id="adminSubscriptionChart"></canvas></div></div></div>`,
        'admin-manage-users-page': `<div class="bg-white p-6 rounded-xl shadow-md"><h2 class="text-2xl font-bold mb-4">User Management</h2><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr><th class="px-4 py-3">User Email</th><th class="px-4 py-3">Plan</th><th class="px-4 py-3">Status</th><th class="px-4 py-3">Student Count</th><th class="px-4 py-3">Date Created</th><th class="px-4 py-3">Actions</th></tr></thead><tbody id="manage-users-table-body"></tbody></table></div></div>`,
        'admin-settings-page': `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white p-6 rounded-xl shadow-md"><h2 class="text-2xl font-bold mb-4">Post a New Announcement</h2><form id="announcement-form" class="space-y-4"><div><label class="text-sm font-medium">Title</label><input type="text" name="title" required class="w-full p-2 border rounded mt-1"></div><div><label class="text-sm font-medium">Content</label><textarea name="content" rows="4" required class="w-full p-2 border rounded mt-1"></textarea></div><div><label class="text-sm font-medium">Type</label><select name="type" class="w-full p-2 border rounded mt-1"><option value="info">Info (Blue)</option><option value="success">Success (Green)</option><option value="warning">Warning (Yellow)</option><option value="error">Error (Red)</option></select></div><div class="text-right"><button type="submit" class="px-6 py-2 text-white gradient-bg rounded-lg font-semibold">Post Announcement</button></div></form></div><div class="bg-white p-6 rounded-xl shadow-md"><h2 class="text-2xl font-bold mb-4">System Danger Zone</h2><div class="space-y-4"><div class="p-4 border border-red-200 rounded-lg bg-red-50"><p class="font-semibold text-red-800">Clear All User Data</p><p class="text-sm text-red-600 mb-2">This will permanently delete all scores and school data for all users. This cannot be undone.</p><button onclick="alert('This is a demo. Action disabled.')" class="px-4 py-2 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700">Clear All Data</button></div></div></div></div>`,
        'admin-analytics-page': `<div class="bg-white p-6 rounded-xl shadow-md"><h2 class="text-2xl font-bold mb-4">System Analytics</h2><p class="text-gray-600">User growth and platform engagement over time.</p><div class="mt-6"><canvas id="adminUserGrowthChart"></canvas></div></div>`,
        'schools-page': `<div class="bg-white p-6 rounded-xl shadow-md"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Manage Schools</h2><button onclick="showCreateSchoolModal()" class="px-4 py-2 text-white gradient-bg rounded-lg font-semibold">Create New School</button></div><div id="school-list" class="space-y-4"></div></div>`,
        'manage-students-page': `<div class="bg-white p-6 rounded-xl shadow-md">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="field"><label class="text-sm font-medium">Select School</label><select id="student-school-select" class="w-full p-2 border rounded mt-1"><option>Select a school first</option></select></div>
                    <div class="field"><label class="text-sm font-medium">Select Class</label><select id="student-class-select" class="w-full p-2 border rounded mt-1" disabled><option>Select a school</option></select></div>
                </div>
                <div id="student-management-content" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="showBulkStudentModal()" class="btn">Bulk Add Students</button>
                        <button onclick="showStudentModal()" class="btn primary">Add New Student</button>
                    </div>
                    <div class="table-wrap" style="max-height: 500px;">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th class="px-4 py-3">Picture</th>
                                    <th class="px-4 py-3">Student ID</th>
                                    <th class="px-4 py-3">Name</th>
                                    <th class="px-4 py-3">Class</th>
                                    <th class="px-4 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="student-list-body">
                                <tr><td colspan="5" class="text-center p-4">No students found for this class.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`,
        'scores-page': `<div class="bg-white p-6 rounded-xl shadow-md mb-6"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="field"><label class="text-sm font-medium">Select School</label><select id="score-school-select" class="w-full p-2 border rounded mt-1"><option>Select a school first</option></select></div><div class="field"><label class="text-sm font-medium">Select Class</label><select id="score-class-select" class="w-full p-2 border rounded mt-1" disabled><option>Select a school</option></select></div></div></div><div id="assessment-content" class="hidden"><div class="mb-4 border-b border-gray-200"><ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="assessment-tabs" role="tablist"><li role="presentation"><button class="inline-block p-4 border-b-2 rounded-t-lg" data-tabs-target="#data-entry" type="button" role="tab">Data Entry</button></li><li role="presentation"><button class="inline-block p-4 border-b-2 rounded-t-lg" data-tabs-target="#upload-excel" type="button" role="tab">Upload Excel</button></li><li role="presentation"><button class="inline-block p-4 border-b-2 rounded-t-lg" data-tabs-target="#summary" type="button" role="tab">Summary</button></li><li role="presentation"><button class="inline-block p-4 border-b-2 rounded-t-lg" data-tabs-target="#raw-score" type="button" role="tab">RAW SCORE</button></li></ul></div><div><div class="assessment-page" id="data-entry" role="tabpanel"><div class="card grid-2"><form id="assessmentEntryForm" class="form"><input type="hidden" name="scoreId"><div class="field"><label>Student Name</label><select name="student_id_code" required class="w-full p-2 border rounded mt-1"></select></div><div class="field"><label>Subject</label><select name="subject" required></select></div><div class="field"><label>CAT 1 (15)</label><input name="cat1" type="number" min="0" max="15" required></div><div class="field"><label>CAT 2 (15)</label><input name="cat2" type="number" min="0" max="15" required></div><div class="field"><label>CAT 3 (15)</label><input name="cat3" type="number" min="0" max="15" required></div><div class="field"><label>CAT 4 (15)</label><input name="cat4" type="number" min="0" max="15" required></div><div class="field"><label>Exam (100)</label><input name="exam" type="number" min="0" max="100" required></div><div class="actions flex gap-2"><button type="submit" class="btn primary">Add Record</button><button type="button" onclick="clearAssessmentForm()" class="btn">Clear</button></div></form><div class="preview"><h3>Recent Entries</h3><div class="table-wrap"><table id="assessmentEntryTable"><thead><tr><th>ID</th><th>Name</th><th>Subject</th><th>C1-C4</th><th>Exam</th><th>Actions</th></tr></thead><tbody></tbody></table></div></div></div></div><div class="assessment-page hidden" id="upload-excel" role="tabpanel"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="card"><h3 class="text-lg font-bold mb-2">1. Download Templates</h3><p class="text-sm text-gray-600 mb-4">Templates are specific to the selected class. Download a template for each subject you need to enter scores for.</p><div id="subject-count-info" class="text-sm text-blue-700 bg-blue-50 p-3 rounded-lg my-4 hidden"></div><div id="template-download-list" class="space-y-2"></div></div><div class="card"><h3 class="text-lg font-bold mb-2">2. Upload Completed Templates</h3><p class="text-sm text-gray-600 mb-4">After filling out a template, upload it here against the correct subject.</p><div id="file-upload-list" class="space-y-4"></div></div></div></div><div class="assessment-page hidden" id="summary" role="tabpanel"><div class="card"><div class="field mb-4"><label class="text-sm font-medium">Select Subject to View Summary</label><select id="summary-subject-select" class="w-full p-2 border rounded mt-1"><option value="">-- Select a subject --</option></select></div><div class="table-wrap"><table id="summaryTable"><thead><tr><th>Rank</th><th>ID</th><th>Name</th><th>Class Score (50%)</th><th>Exams Score (50%)</th><th>Total (100%)</th></tr></thead><tbody><tr><td colspan="6" class="text-center text-gray-500 py-4">Please select a subject to view the summary.</td></tr></tbody></table></div></div></div><div class="assessment-page hidden" id="raw-score" role="tabpanel"><div class="card"><div class="flex justify-end gap-2 p-2 border-b"><button onclick="downloadRawScoreAsPDF()" class="btn text-sm">Download PDF</button><button onclick="printRawScoreSheet()" class="btn primary text-sm">Print Sheet</button></div><div id="raw-score-sheet-container" class="p-2"><div class="text-center p-8 text-gray-500">Please select a school and class to view the Raw Score Sheet.</div></div></div></div></div></div>`,
        // *** MODIFIED reports-page HTML ***
        'reports-page': `<div class="bg-white p-6 sm:p-8 rounded-xl shadow-md">
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-slate-800">Generate Reports</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full md:w-auto">
                        <div class="field"><label class="text-sm font-medium">Select School</label><select id="report-school-select" class="w-full p-2 border rounded mt-1"></select></div>
                        <div class="field"><label class="text-sm font-medium">Select Class</label><select id="report-class-select" class="w-full p-2 border rounded mt-1" disabled></select></div>
                    </div>
                </div>
                <div id="report-generation-content" class="hidden">
                     <div class="flex justify-end mb-4">
                        <button id="bulk-download-btn" onclick="handleBulkDownload()" class="px-4 py-2 text-white gradient-bg rounded-lg font-semibold">Bulk Download Reports (Pro)</button>
                     </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr>
                                    <th class="px-6 py-3">Student ID</th>
                                    <th class="px-6 py-3">Name</th>
                                    <th class="px-6 py-3">Class</th>
                                    <th class="px-6 py-3 text-center">Action</th> <!-- Changed header -->
                                </tr>
                            </thead>
                            <tbody id="report-student-list">
                                 <tr><td colspan="4" class="text-center p-4 text-gray-500">Select a class to see students.</td></tr> <!-- Simplified example row -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`,
        // *** MODIFIED settings-page HTML ***
        'settings-page': `<div class="bg-white p-6 sm:p-8 rounded-xl shadow-md max-w-4xl mx-auto"><h2 class="text-2xl font-bold text-gray-800 mb-6">Setup School</h2><div class="mb-6"><label class="block text-sm font-medium text-gray-700">Select School to Configure</label><select id="settings-school-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm"></select></div>
            <form id="settings-form" class="space-y-6 hidden form">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6"><div><label class="block text-sm font-medium text-gray-700">School Name</label><input type="text" name="school_name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2"></div><div><label class="block text-sm font-medium text-gray-700">School's Tel. No</label><input type="text" name="school_tel" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2"></div></div>
                <div><label class="block text-sm font-medium text-gray-700">Postal Address</label><input type="text" name="postal_address" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2"></div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6"><div><label class="block text-sm font-medium text-gray-700">Term</label><input type="number" name="term" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2"></div><div><label class="block text-sm font-medium text-gray-700">Year</label><input type="number" name="year" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2"></div><div><label class="block text-sm font-medium text-gray-700">Number of Open Days</label><input type="number" name="number_of_open_days" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2"></div></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6"><div><label class="block text-sm font-medium text-gray-700">Vacation Date</label><input type="date" name="vacation_date" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2"></div><div><label class="block text-sm font-medium text-gray-700">Re-opening Date</label><input type="date" name="reopening_date" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2"></div></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6"><div><label class="block text-sm font-medium text-gray-700">Number on Roll</label><input type="number" name="number_on_roll" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2"></div><div><label class="block text-sm font-medium text-gray-700">Class Teacher Tel.</label><input type="tel" name="class_teacher_tel" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2"></div></div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Grading System</label>
                    <select name="grading_system" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2">
                        <option value="1">Setup 1 (Excellent, Very Good...)</option>
                        <option value="2">Setup 2 (Highest, Higher...)</option>
                        <option value="3">Setup 3 (Highly Proficient...)</option>
                    </select>
                </div>
                <div> <!-- Added Report Layout Select -->
                    <label class="block text-sm font-medium text-gray-700">Default Report Layout</label>
                    <select name="report_layout" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2">
                        <option value="1">Layout 1</option>
                        <option value="2">Layout 2</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div><label class="block text-sm font-medium text-gray-700">Headteacher Signature</label><input type="file" name="head_signature_file" class="mt-1 block w-full text-sm"></div>
                    <div id="school-crest-upload-field"><label class="block text-sm font-medium text-gray-700">School Crest/Logo</label><input type="file" name="school_crest_file" class="mt-1 block w-full text-sm"></div>
                </div>
                <div class="pt-4 flex justify-end"><button type="submit" class="px-6 py-2 text-sm font-medium text-white gradient-bg rounded-lg">Save Settings</button></div>
            </form>
        </div>`,
        'subscribe-page': `<div class="bg-white p-8 rounded-xl shadow-md max-w-5xl mx-auto"><h2 class="text-2xl font-bold mb-2">Subscription Management</h2><p class="text-gray-600 mb-6">Choose a plan that fits your needs. Your current plan is: <span id="current-plan-display" class="font-bold text-purple-600"></span></p><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"><div class="plan-card border p-6 rounded-lg cursor-pointer" onclick="selectPlan(this, 'Demo', 0)"><h3 class="font-bold text-lg">Demo</h3><p class="text-2xl font-bold">Free</p><ul class="text-xs space-y-1 mt-2 text-gray-600"><li>1 School, 1 Class, 1 Student</li><li>Preview Reports</li></ul></div><div class="plan-card border p-6 rounded-lg cursor-pointer" onclick="selectPlan(this, 'Basic', 50)"><h3 class="font-bold text-lg">Basic</h3><p class="text-2xl font-bold">GHS 50<span class="text-base font-normal">/year</span></p><ul class="text-xs space-y-1 mt-2 text-gray-600"><li>Unlimited Schools & Classes</li><li>Bulk Student Add</li><li>Download All Reports</li></ul></div><div class="plan-card border p-6 rounded-lg cursor-pointer" onclick="selectPlan(this, 'Pro', 100)"><h3 class="font-bold text-lg">Pro</h3><p class="text-2xl font-bold">GHS 100<span class="text-base font-normal">/year</span></p><ul class="text-xs space-y-1 mt-2 text-gray-600"><li>Everything in Basic</li><li>Upload School Crest</li><li>Excel Upload/Download</li></ul></div><div class="plan-card border p-6 rounded-lg cursor-pointer" onclick="selectPlan(this, 'Pro Plus', 150)"><h3 class="font-bold text-lg">Pro Plus</h3><p class="text-2xl font-bold">GHS 150<span class="text-base font-normal">/year</span></p><ul class="text-xs space-y-1 mt-2 text-gray-600"><li>Everything in Pro</li><li>Add Student Pictures</li><li>Crest as Watermark</li></ul></div></div><div id="payment-details" class="hidden"><div class="text-center mb-6"><p class="text-gray-600">Total Amount to Pay:</p><p class="text-3xl font-bold text-purple-600">GHS <span id="total-amount">0.00</span></p></div><div class="flex justify-center gap-4 mb-6 border-b pb-4"><button id="btn-momo" class="px-4 py-2 rounded-lg bg-purple-600 text-white" onclick="showPaymentForm('momo')">Pay with Mobile Money</button><button id="btn-card" class="px-4 py-2 rounded-lg bg-gray-200" onclick="showPaymentForm('card')">Pay with Card</button></div><div id="momo-form"><h3 class="font-semibold text-lg mb-4">Mobile Money Payment</h3><form onsubmit="handlePayment(event)"><div class="space-y-4"><select class="w-full p-3 border rounded-lg"><option>MTN Mobile Money</option><option>Vodafone Cash</option><option>AirtelTigo Money</option></select><input type="tel" placeholder="Phone Number (e.g., 024xxxxxxx)" class="w-full p-3 border rounded-lg" required><button type="submit" class="w-full py-3 px-4 bg-green-600 text-white rounded-lg font-semibold">Pay GHS <span id="momo-amount">0.00</span></button></div></form></div><div id="card-form" class="hidden"><h3 class="font-semibold text-lg mb-4">Credit Card Payment</h3><form onsubmit="handlePayment(event)"><div class="space-y-4"><input type="text" placeholder="Card Number" class="w-full p-3 border rounded-lg" required><div class="grid grid-cols-2 gap-4"><input type="text" placeholder="MM / YY" class="p-3 border rounded-lg" required><input type="text" placeholder="CVC" class="p-3 border rounded-lg" required></div><button type="submit" class="w-full py-3 px-4 bg-green-600 text-white rounded-lg font-semibold">Pay GHS <span id="card-amount">0.00</span></button></div></form></div></div><div class="text-center mt-8"><p class="text-sm text-gray-500">New users start on a free Demo plan.</p></div></div>`,
        'user-profile-page': `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2"><div class="bg-white p-6 sm:p-8 rounded-xl shadow-md"><h2 class="text-2xl font-bold text-gray-800 mb-6">User Profile</h2><form id="user-profile-form" class="space-y-6"><div class="flex items-center gap-6"><img id="profile-pic-preview" src="https://via.placeholder.com/96" class="h-24 w-24 rounded-full object-cover"><div><label class="block text-sm font-medium text-gray-700">Change Profile Picture</label><input type="file" name="profile_picture_file" class="mt-1 block w-full text-sm"></div></div><div><label class="block text-sm font-medium text-gray-700">Full Name</label><input type="text" name="fullName" id="profile-name-input" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2"></div><div><label class="block text-sm font-medium text-gray-700">Email Address</label><input type="email" id="profile-email-input" disabled class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 bg-gray-100 cursor-not-allowed"></div><div class="pt-4 flex justify-end"><button type="submit" class="px-6 py-2 text-sm font-medium text-white gradient-bg rounded-lg">Save Changes</button></div></form></div></div><div><div class="bg-white p-6 sm:p-8 rounded-xl shadow-md space-y-6"><div><h3 class="text-lg font-bold text-gray-800">Change Password</h3><form id="change-password-form" class="mt-4 space-y-4"><div_><label class="block text-sm font-medium text-gray-700">New Password</label><input type="password" name="new_password" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2"></div><div><label class="block text-sm font-medium text-gray-700">Confirm New Password</label><input type="password" name="confirm_password" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2"></div><div class="flex justify-end"><button type="submit" class="px-4 py-2 text-sm font-medium text-white gradient-bg rounded-lg">Update Password</button></div></form></div><div class="border-t pt-6"><h3 class="text-lg font-bold text-red-600">Danger Zone</h3><p class="text-sm text-gray-600 mt-2">Deleting your account is permanent and will remove all your data, including schools, students, and assessment scores. This action cannot be undone.</p><button type="button" onclick="handleDeleteAccount()" class="mt-4 w-full px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700">Delete My Account</button></div></div></div></div>`
    };

    let newSchoolType = null;
    let selectedPlan = { name: '', amount: 0 };

    // --- [SIMULATED API Functions for Frontend Preview] ---
    async function apiCall(endpoint, method = 'GET', body = null) {
        console.log(`Simulating API Call: ${method} to ${endpoint}`);
        return new Promise((resolve) => {
            setTimeout(() => {
                if (endpoint === 'scores.php') {
                    if (method === 'GET') {
                        resolve({ status: 'success', data: appState.scores });
                    } else if (method === 'POST') {
                        const scoreId = body.get('scoreId');
                        if (scoreId) { // This is an update
                            const scoreIndex = appState.scores.findIndex(s => s.id == scoreId);
                            if (scoreIndex !== -1) {
                                for (let [key, value] of body.entries()) {
                                    if(key !== 'scoreId') appState.scores[scoreIndex][key] = value;
                                }
                                resolve({ status: 'success', message: 'Score updated.' });
                            } else {
                                resolve({ status: 'error', message: 'Score not found.' });
                            }
                        } else { // This is a new entry
                            const newScore = {};
                            for (let [key, value] of body.entries()) { newScore[key] = value; }
                            newScore.id = Date.now();
                             const student = appState.students.find(s => s.studentIdCode === newScore.student_id_code);
                            if(student) newScore.name = student.name;
                            
                            appState.scores.unshift(newScore);
                            resolve({ status: 'success', message: 'Score added.' });
                        }
                    }
                } else if (endpoint.startsWith('settings.php')) {
                    if (method === 'GET') { resolve({ status: 'success', data: appState.settings }); }
                    else if (method === 'POST') { appState.settings = { ...appState.settings, ...JSON.parse(body) }; resolve({ status: 'success', message: 'Settings saved.' }); }
                } else if (endpoint === 'upload.php') {
                    if (method === 'POST') {
                        const file = body.get('file');
                        if(!file) { resolve({ status: 'success', filePath: null }); return; }
                        const reader = new FileReader();
                        reader.onload = (e) => resolve({ status: 'success', filePath: e.target.result });
                        reader.readAsDataURL(file);
                    }
                }
            }, 300);
        });
    }

    // --- [Business Logic & Calculations] ---
    const businessLogic = {
        calculateScoresAndRank(scores) {
            let withScores = scores.map(s => { const totalCAT = (Number(s.cat1) || 0) + (Number(s.cat2) || 0) + (Number(s.cat3) || 0) + (Number(s.cat4) || 0); const catScaled = (totalCAT / 60) * 50; const examScaled = (Number(s.exam) / 100) * 50; const total = catScaled + examScaled; return { ...s, totalCAT, catScaled, examScaled, total }; });
            withScores.sort((a, b) => b.total - a.total);
            let rank = 0, lastScore = -1, displayRank = 0;
            withScores.forEach(s => { rank++; if (s.total !== lastScore) displayRank = rank; s.rank = displayRank; lastScore = s.total; });
            return withScores;
        },
        getGradeAndRemarks(score, system = '1') { score = parseFloat(score); if (system == '1') { if (score >= 79.5) return { grade: 'A', remarks: 'EXCELLENT' }; if (score >= 69.5) return { grade: 'B+', remarks: 'VERY GOOD' }; if (score >= 59.5) return { grade: 'B', remarks: 'GOOD' }; if (score >= 54.5) return { grade: 'C+', remarks: 'CREDIT' }; if (score >= 49.5) return { grade: 'C', remarks: 'AVERAGE' }; if (score >= 44.5) return { grade: 'D+', remarks: 'PASS' }; if (score >= 39.5) return { grade: 'D', remarks: 'WEAK PASS' }; if (score >= 34.5) return { grade: 'E', remarks: 'VERY WEAK PASS' }; return { grade: 'F', remarks: 'FAIL' }; } if (system == '2') { if (score >= 79.5) return { grade: '1', remarks: 'HIGHEST' }; if (score >= 69.5) return { grade: '2', remarks: 'HIGHER' }; if (score >= 59.5) return { grade: '3', remarks: 'HIGH' }; if (score >= 54.5) return { grade: '4', remarks: 'HIGH AVERAGE' }; if (score >= 49.5) return { grade: '5', remarks: 'AVERAGE' }; if (score >= 44.5) return { grade: '6', remarks: 'LOW AVERAGE' }; if (score >= 39.5) return { grade: '7', remarks: 'LOW' }; if (score >= 34.5) return { grade: '8', remarks: 'LOWER' }; return { grade: '9', remarks: 'LOWEST' }; } if (system == '3') { if (score >= 79.5) return { grade: 'Grade A', remarks: 'HIGHLY PROFICIENT' }; if (score >= 69.5) return { grade: 'Grade A', remarks: 'PROFICIENT' }; if (score >= 59.5) return { grade: 'Grade P', remarks: 'APPROACHING PROFICIENT' }; if (score >= 54.5) return { grade: 'Grade AP', remarks: 'APPROACHING PROFICIENT' }; if (score >= 49.5) return { grade: 'Grade AP', remarks: 'DEVELOPING' }; return { grade: 'Grade B', remarks: 'EMERGING' }; } return { grade: '', remarks: '' }; },
        getAttitudeRemark(score) { if (score >= 75) return 'HARD WORKING'; if (score >= 65) return 'Focused'; if (score >= 55) return 'Attentive'; if (score >= 45) return 'Determined'; if (score >= 35) return 'Forceful'; return 'Inattentive'; },
        getTeacherRemark(score) { if (score >= 85) return 'Keep It Up'; if (score >= 75) return 'Impressive'; if (score >= 65) return 'Could Do Better'; if (score >= 55) return 'Should Work Hard'; if (score >= 45) return 'Should Be Serious'; if (score >= 35) return 'More Room For Improvement'; return 'Needs Extra Assistance'; },
        getInterest(bestSubject) { const map = { 'Science': 'Researching', 'History': 'Reading and writing', 'Creative Art': 'Drawing', 'Computing': 'Writing', 'Physical Education': 'Sports', 'Home Economics': 'Cooking', 'Default': 'Playing' }; return map[bestSubject] || map['Default']; },
        getPositionPerSubject(studentId, subject, allScores) { const subjectScores = allScores.filter(s => s.subject === subject); const ranked = this.calculateScoresAndRank(subjectScores); const studentRank = ranked.find(s => s.student_id_code === studentId)?.rank; return studentRank ? `${studentRank}${['st','nd','rd'][((studentRank+90)%100-10)%10-1]||'th'}` : 'N/A'; },
        getCoreAndBestSubjects(scores) { const coreSubjects = ['English Language', 'Mathematics', 'Science', 'History']; const coreScores = scores.filter(s => coreSubjects.includes(s.subject)); const electiveScores = scores.filter(s => !coreSubjects.includes(s.subject)); electiveScores.sort((a, b) => b.total - a.total); return { core: coreScores, best: electiveScores.slice(0, 2) }; }
    };

    function getExpectedSubjectCount(className) {
        if (!className) return 0;
        const subjects = getSubjectsForClass(className);
        return subjects.length;
    }

    // --- [UI Navigation & Control] ---
    window.showLogin = (event) => { if(event) event.preventDefault(); document.getElementById('auth-container').classList.remove('hidden'); document.getElementById('signup-page').classList.add('hidden'); document.getElementById('login-page').classList.remove('hidden'); }
    window.showSignUp = (event) => { if(event) event.preventDefault(); document.getElementById('auth-container').classList.remove('hidden'); document.getElementById('login-page').classList.add('hidden'); document.getElementById('signup-page').classList.remove('hidden'); }
    window.hideAuthModals = () => { document.getElementById('auth-container').classList.add('hidden'); }
    window.showBulkStudentModal = () => { document.getElementById('bulk-student-modal').classList.remove('hidden'); }
    window.hideBulkStudentModal = () => { document.getElementById('bulk-student-modal').classList.add('hidden'); }
    window.login = (role, emailParam = null) => {
        let email;
        if (emailParam) {
            email = emailParam;
        } else if (role === 'system_admin') {
            email = 'admin@sbahub.com';
        } else {
            email = document.getElementById('login-email').value;
        }

        if (!email) {
            showToast('Please enter an email address.', 'error');
            return;
        }

        if (!appState.users[email]) {
            showToast('User not found. Please sign up first.', 'error');
            return;
        }
        const user = appState.users[email];
        
        if (user.status === 'Inactive') {
            showToast('Your account is inactive. Please contact the system administrator.', 'error');
            return;
        }

        appState.currentUser = email;
        
        hideAuthModals();
        document.getElementById('public-container').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        populateNav(role);
        
        const firstPage = (role === 'system_admin') ? adminNavLinks[0].pageId : userNavLinks[0].pageId;
        
        if (role === 'system_admin') {
            navigateApp(firstPage);
        } else {
            fetchInitialData().then(() => navigateApp(firstPage));
        }
    }
    window.logout = () => { document.getElementById('app-container').classList.add('hidden'); document.getElementById('public-container').classList.remove('hidden'); }
    window.populateNav = (role) => { const links = role === 'system_admin' ? adminNavLinks : userNavLinks; document.getElementById('nav-container').innerHTML = links.map(link => `<a href="#" data-pageid="${link.pageId}" onclick="navigateApp('${link.pageId}')" class="nav-link flex items-center gap-3 w-full px-4 py-3 text-sm rounded-lg text-purple-100 hover:bg-white/20">${link.icon || ''} ${link.name}</a>`).join(''); }
    window.navigateApp = (pageId) => { 
        document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden')); 
        const target = document.getElementById(pageId); 
        if (target) { 
            target.innerHTML = pageContents[pageId]; 
            target.classList.remove('hidden'); 
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.pageid === pageId);
            });

            document.getElementById('page-title').textContent = (adminNavLinks.find(l => l.pageId === pageId) || userNavLinks.find(l=> l.pageId === pageId)).name; 
            
            const pageInitializers = {
                'dashboard-page': initializeDashboardPage,
                'schools-page': initializeSchoolsPage,
                'settings-page': initializeSettingsPage,
                'manage-students-page': initializeManageStudentsPage,
                'scores-page': initializeScoresPage,
                'reports-page': initializeReportsPage,
                'subscribe-page': initializeSubscribePage,
                'user-profile-page': initializeUserProfilePage,
                'admin-dashboard-page': initializeAdminDashboard,
                'admin-manage-users-page': initializeAdminManageUsers,
                'admin-settings-page': initializeAdminSettings,
                'admin-analytics-page': initializeAdminAnalytics,
            };

            if (pageInitializers[pageId]) {
                pageInitializers[pageId]();
            }
        } 
    }

    // --- [Bulk Student Modal Tab Switcher] ---
    window.switchBulkAddTab = (buttonEl, tabName) => {
        // Switch tabs styling
        document.querySelectorAll('.bulk-add-tab').forEach(tab => {
            tab.classList.remove('border-purple-600', 'text-purple-600');
            tab.classList.add('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
        });
        buttonEl.classList.add('border-purple-600', 'text-purple-600');
        buttonEl.classList.remove('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
        
        // Switch content
        document.querySelectorAll('.bulk-add-tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        document.getElementById(`bulk-add-${tabName}`).classList.remove('hidden');
    }

    // --- [PAGE INITIALIZATION FUNCTIONS] ---
    window.initializeDashboardPage = () => { 
        // --- Existing Metric Card Logic ---
        document.getElementById('metric-total-students').textContent = appState.students.length; 
        document.getElementById('metric-total-schools').textContent = appState.schools.length; 
        
        const processedScores = businessLogic.calculateScoresAndRank(appState.scores); 
        const totalScoresSum = processedScores.reduce((sum, s) => sum + s.total, 0); 
        const averageScore = appState.scores.length > 0 ? (totalScoresSum / appState.scores.length) : 0; 
        document.getElementById('metric-average-score').textContent = `${averageScore.toFixed(1)}%`; 
        
        const subCard = document.getElementById('metric-subscription'); 
        const user = appState.users[appState.currentUser]; 
        if(user){
            subCard.textContent = user.plan;
            if (user.plan === 'Pro') { subCard.className = 'text-2xl font-bold text-green-600'; }
            else if (user.plan === 'Demo') { subCard.className = 'text-2xl font-bold text-yellow-600'; }
            else { subCard.className = 'text-2xl font-bold text-red-600'; }
        }
        
        // --- Existing Subject Performance Chart Logic ---
        const subjectScores = {}; 
        processedScores.forEach(s => { if (!subjectScores[s.subject]) subjectScores[s.subject] = { total: 0, count: 0 }; subjectScores[s.subject].total += s.total; subjectScores[s.subject].count++; }); 
        const subjectLabels = Object.keys(subjectScores); 
        const subjectAverages = subjectLabels.map(label => subjectScores[label].total / subjectScores[label].count); 
        
        const barCtx = document.getElementById('subjectPerformanceChart')?.getContext('2d');
        if(barCtx) new Chart(barCtx, { type: 'bar', data: { labels: subjectLabels, datasets: [{ label: 'Average Score', data: subjectAverages, backgroundColor: 'rgba(102, 126, 234, 0.5)', borderColor: 'rgba(102, 126, 234, 1)', borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true, max: 100 } } } }); 
        
        // --- Existing Announcements Logic ---
        const announcementsList = document.getElementById('announcements-list');
        const colorMap = { info: 'blue', success: 'green', warning: 'yellow', error: 'red' };
        if(announcementsList) announcementsList.innerHTML = appState.announcements.map(a => `<div class="p-3 bg-${colorMap[a.type]}-50 rounded-lg text-sm"><p class="font-semibold text-${colorMap[a.type]}-800">${a.title}</p><p class="text-${colorMap[a.type]}-700">${a.content}</p></div>`).join('');

        // --- [NEW] School Performance Chart & Table Logic ---
        const userSchools = appState.schools.filter(s => s.createdBy === appState.currentUser);
        const schoolSummaryData = [];
        
        userSchools.forEach(school => {
            const schoolScores = appState.scores.filter(s => s.schoolId == school.id);
            const processedSchoolScores = businessLogic.calculateScoresAndRank(schoolScores);
            
            // 1. Calculate overall average for the school
            const schoolTotalSum = processedSchoolScores.reduce((sum, s) => sum + s.total, 0);
            const schoolAverage = processedSchoolScores.length > 0 ? (schoolTotalSum / processedSchoolScores.length) : 0;
            
            // 2. Calculate best subject for the school
            const schoolSubjectScores = {};
            processedSchoolScores.forEach(s => {
                if (!schoolSubjectScores[s.subject]) schoolSubjectScores[s.subject] = { total: 0, count: 0 };
                schoolSubjectScores[s.subject].total += s.total;
                schoolSubjectScores[s.subject].count++;
            });
            
            let bestSubject = 'N/A';
            let maxAvg = -1;
            for (const subject in schoolSubjectScores) {
                const avg = schoolSubjectScores[subject].total / schoolSubjectScores[subject].count;
                if (avg > maxAvg) {
                    maxAvg = avg;
                    bestSubject = subject;
                }
            }
            
            schoolSummaryData.push({
                name: school.name,
                average: schoolAverage,
                bestSubject: bestSubject
            });
        });

        // 3. Render School Performance Chart
        const schoolCtx = document.getElementById('schoolPerformanceChart')?.getContext('2d');
        if (schoolCtx) {
            new Chart(schoolCtx, {
                type: 'bar',
                data: {
                    labels: schoolSummaryData.map(s => s.name),
                    datasets: [{
                        label: 'Average Score',
                        data: schoolSummaryData.map(s => s.average),
                        backgroundColor: 'rgba(139, 92, 246, 0.5)',
                        borderColor: 'rgba(139, 92, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });
        }
        
        // 4. Render School Summary Table
        const schoolTableBody = document.getElementById('school-summary-table');
        if (schoolTableBody) {
            if (schoolSummaryData.length > 0) {
                schoolTableBody.innerHTML = schoolSummaryData
                    .sort((a, b) => b.average - a.average) // Sort by best average
                    .map(d => `
                        <tr class="border-b">
                            <td class="py-2 font-medium">${d.name}</td>
                            <td class="py-2">${d.average.toFixed(1)}%</td>
                            <td class="py-2 text-xs">${d.bestSubject}</td>
                        </tr>
                    `).join('');
            } else {
                schoolTableBody.innerHTML = `<tr><td colspan="3" class="py-4 text-center text-gray-500">No schools created yet.</td></tr>`;
            }
        }
    }
    
    function getSubjectsForClass(className) {
        if (!className) return [];
        if (className.startsWith('KG')) return subjectsByLevel['KG'];
        if (className.startsWith('BS')) {
            const level = parseInt(className.match(/\d+/)[0]);
            if (level >= 1 && level <= 3) return subjectsByLevel['BS1-3'];
            if (level >= 4 && level <= 6) return subjectsByLevel['BS4-6'];
            if (level >= 7 && level <= 9) return subjectsByLevel['BS7-9'];
        }
        return [];
    }

    window.initializeManageStudentsPage = () => {
        const schoolSelect = document.getElementById('student-school-select');
        const classSelect = document.getElementById('student-class-select');
        const contentDiv = document.getElementById('student-management-content');

        const userSchools = appState.schools.filter(s => s.createdBy === appState.currentUser);
        schoolSelect.innerHTML = '<option value="">-- Select School --</option>' + userSchools.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

        schoolSelect.onchange = () => {
            const schoolId = schoolSelect.value;
            const school = appState.schools.find(s => s.id == schoolId);
            if (school) {
                classSelect.innerHTML = '<option value="">-- Select Class --</option>' + school.classes.map(c => `<option value="${c}">${c}</option>`).join('');
                classSelect.disabled = false;
            } else {
                classSelect.innerHTML = '<option>Select a school</option>';
                classSelect.disabled = true;
                contentDiv.classList.add('hidden');
            }
            classSelect.dispatchEvent(new Event('change'));
        };

        classSelect.onchange = () => {
            if (classSelect.value) {
                contentDiv.classList.remove('hidden');
                renderStudentList();
                
                const user = appState.users[appState.currentUser];
                const bulkAddBtn = contentDiv.querySelector('button[onclick="showBulkStudentModal()"]');
                if (user && !['Basic', 'Pro', 'Pro Plus'].includes(user.plan)) {
                    bulkAddBtn.disabled = true;
                    bulkAddBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    bulkAddBtn.title = "Upgrade to Basic plan to use this feature.";
                }

            } else {
                contentDiv.classList.add('hidden');
            }
        };
    };
    
    window.initializeScoresPage = () => {
        const schoolSelect = document.getElementById('score-school-select');
        const classSelect = document.getElementById('score-class-select');
        const assessmentContent = document.getElementById('assessment-content');

        const userSchools = appState.schools.filter(s => s.createdBy === appState.currentUser);
        schoolSelect.innerHTML = '<option value="">-- Select School --</option>' + userSchools.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        
        schoolSelect.onchange = () => {
            const schoolId = schoolSelect.value;
            const school = appState.schools.find(s => s.id == schoolId);
            if (school) {
                classSelect.innerHTML = '<option value="">-- Select Class --</option>' + school.classes.map(c => `<option value="${c}">${c}</option>`).join('');
                classSelect.disabled = false;
            } else {
                classSelect.innerHTML = '<option>Select a school</option>';
                classSelect.disabled = true;
                assessmentContent.classList.add('hidden');
            }
            classSelect.dispatchEvent(new Event('change'));
        };

        classSelect.onchange = () => {
            const subjectsForClass = getSubjectsForClass(classSelect.value);
            const summarySubjectSelect = document.getElementById('summary-subject-select');
            
            if (summarySubjectSelect) {
                summarySubjectSelect.innerHTML = '<option value="">-- Select a subject --</option><option value="All">All Subjects</option>' + subjectsForClass.map(s => `<option value="${s}">${s}</option>`).join('');
                summarySubjectSelect.onchange = renderScoresSummary;
            }

            if (classSelect.value) {
                assessmentContent.classList.remove('hidden');
                const tabs = document.querySelectorAll('#assessment-tabs button'); 
                const user = appState.users[appState.currentUser];
                tabs.forEach(tab => { 
                    if (user && !['Pro', 'Pro Plus'].includes(user.plan) && tab.dataset.tabsTarget === "#upload-excel") {
                        tab.disabled = true;
                        tab.classList.add('opacity-50', 'cursor-not-allowed');
                        tab.title = "Upgrade to Pro to use Excel Upload.";
                    }
                    tab.addEventListener('click', () => { 
                        tabs.forEach(t => t.classList.remove('border-purple-600', 'text-purple-600')); 
                        tab.classList.add('border-purple-600', 'text-purple-600'); 
                        document.querySelectorAll('.assessment-page').forEach(p => p.classList.add('hidden')); 
                        document.querySelector(tab.dataset.tabsTarget).classList.remove('hidden'); 
                        if (tab.dataset.tabsTarget === '#summary') renderScoresSummary(); 
                        if (tab.dataset.tabsTarget === '#raw-score') renderRawScoreSheet();
                    }); 
                }); 
                if(tabs.length) tabs[0].click();

                const assessmentForm = document.getElementById('assessmentEntryForm');
                
                const dataEntrySubjectSelect = document.querySelector('#assessmentEntryForm select[name="subject"]');
                if (dataEntrySubjectSelect) {
                    dataEntrySubjectSelect.innerHTML = '<option value="">-- Select Subject --</option>' + subjectsForClass.map(s => `<option value="${s}">${s}</option>`).join('');
                }

                const studentSelect = document.querySelector('#assessmentEntryForm select[name="student_id_code"]');
                const studentsInClass = appState.students.filter(s => s.schoolId === schoolSelect.value && s.className === classSelect.value);
                if (studentSelect) {
                    studentSelect.innerHTML = '<option value="">-- Select Student --</option>' + studentsInClass.map(s => `<option value="${s.studentIdCode}">${s.name} (${s.studentIdCode})</option>`).join('');
                }


                const templateListContainer = document.getElementById('template-download-list');
                const fileUploadListContainer = document.getElementById('file-upload-list');
                
                if (templateListContainer && fileUploadListContainer) {
                    if (subjectsForClass.length > 0) {
                        templateListContainer.innerHTML = subjectsForClass.map(subject => `
                            <div class="flex justify-between items-center text-sm p-2 bg-gray-50 rounded">
                                <span>${subject}</span>
                                <button type="button" onclick="downloadExcelTemplate('${subject}')" class="btn text-xs">Download</button>
                            </div>
                        `).join('');
                         fileUploadListContainer.innerHTML = subjectsForClass.map(subject => `
                            <form class="subject-upload-form border-t pt-4" onsubmit="handleExcelUpload(event, '${subject}')">
                                <label class="font-semibold text-sm">${subject}</label>
                                <div class="flex items-center gap-2 mt-2">
                                    <input type="file" name="excel_file" class="w-full text-sm text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100" required>
                                    <button type="submit" class="btn primary text-xs flex-shrink-0">Upload</button>
                                </div>
                                <div class="upload-status text-xs text-gray-500 mt-1"></div>
                            </form>
                        `).join('');
                    } else {
                        const placeholder = '<p class="text-sm text-gray-500">Select a class to see subject templates and upload options.</p>';
                        templateListContainer.innerHTML = placeholder;
                        fileUploadListContainer.innerHTML = placeholder;
                    }
                }
                
                if (assessmentForm) assessmentForm.addEventListener('submit', handleAddScore); 
                
                const expectedSubjects = getExpectedSubjectCount(classSelect.value);
                const infoDiv = document.getElementById('subject-count-info');
                if (infoDiv) {
                    if (expectedSubjects > 0) {
                        infoDiv.textContent = `This class level has ${expectedSubjects} subjects.`;
                        infoDiv.classList.remove('hidden');
                    } else {
                        infoDiv.classList.add('hidden');
                    }
                }
                
                renderScoresSummary();
                renderRawScoreSheet();
            } else {
                assessmentContent.classList.add('hidden');
            }
        };
    }
    window.initializeReportsPage = () => { 
        const schoolSelect = document.getElementById('report-school-select');
        const classSelect = document.getElementById('report-class-select');
        const contentDiv = document.getElementById('report-generation-content');

        const userSchools = appState.schools.filter(s => s.createdBy === appState.currentUser);
        schoolSelect.innerHTML = '<option value="">-- Select School --</option>' + userSchools.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

        schoolSelect.onchange = () => {
            const schoolId = schoolSelect.value;
            const school = appState.schools.find(s => s.id == schoolId);
            if (school) {
                classSelect.innerHTML = '<option value="">-- Select Class --</option>' + school.classes.map(c => `<option value="${c}">${c}</option>`).join('');
                classSelect.disabled = false;
            } else {
                classSelect.innerHTML = '<option>Select a school</option>';
                classSelect.disabled = true;
                contentDiv.classList.add('hidden');
            }
            classSelect.dispatchEvent(new Event('change'));
        };

        classSelect.onchange = () => {
            if (classSelect.value) {
                contentDiv.classList.remove('hidden');
                renderReportStudentList();
            } else {
                contentDiv.classList.add('hidden');
            }
        };

        const user = appState.users[appState.currentUser];
        const bulkBtn = document.getElementById('bulk-download-btn');
        if (user && !['Basic', 'Pro', 'Pro Plus'].includes(user.plan)) {
            if (bulkBtn) {
                bulkBtn.disabled = true;
                bulkBtn.classList.add('opacity-50', 'cursor-not-allowed');
                bulkBtn.title = "Upgrade to Basic to bulk download reports.";
            }
        }
    }
    window.initializeSettingsPage = () => {
        const schoolSelect = document.getElementById('settings-school-select');
        const form = document.getElementById('settings-form');
        schoolSelect.innerHTML = '<option value="">-- Select a School --</option>' + appState.schools.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

        schoolSelect.onchange = () => {
            const schoolId = schoolSelect.value;
            if (!schoolId) {
                form.classList.add('hidden');
                return;
            }
            const school = appState.schools.find(s => s.id == schoolId);
            const schoolSettings = school.settings;
            for (const key in schoolSettings) {
                if (form.elements[key] && form.elements[key].type !== 'file') {
                    form.elements[key].value = schoolSettings[key] || '';
                }
            }
            form.classList.remove('hidden');
            const user = appState.users[appState.currentUser];
            const crestField = document.getElementById('school-crest-upload-field');
            if (user && !['Pro', 'Pro Plus'].includes(user.plan)) {
                crestField.classList.add('opacity-50');
                crestField.querySelector('input').disabled = true;
                if (!crestField.querySelector('p')) {
                    const proNotice = document.createElement('p');
                    proNotice.className = 'text-xs text-purple-600 mt-1';
                    proNotice.textContent = 'Upgrade to Pro to add school crest.';
                    crestField.appendChild(proNotice);
                }
            } else {
                crestField.classList.remove('opacity-50');
                crestField.querySelector('input').disabled = false;
                const notice = crestField.querySelector('p');
                if(notice) notice.remove();
            }
        };
        form.addEventListener('submit', handleSaveSettings);
    }
    window.initializeSchoolsPage = () => {
        renderSchoolList();
    }
    window.initializeSubscribePage = () => {
        const user = appState.users[appState.currentUser];
        const planDisplayEl = document.getElementById('current-plan-display');
        if (planDisplayEl && user) {
            planDisplayEl.textContent = user.plan;
        }
        
        document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected'));
        document.getElementById('payment-details').classList.add('hidden');
        selectedPlan = { name: '', amount: 0 };
    }
    window.initializeUserProfilePage = () => {
        const currentUserEmail = appState.currentUser;
        const user = appState.users[currentUserEmail];
        if (!user) return;

        const profileForm = document.getElementById('user-profile-form');
        const passwordForm = document.getElementById('change-password-form');
        const picPreview = document.getElementById('profile-pic-preview');

        profileForm.elements.fullName.value = user.name || '';
        document.getElementById('profile-email-input').value = currentUserEmail;
        picPreview.src = user.pictureUrl || 'https://via.placeholder.com/96';

        profileForm.onsubmit = handleUpdateProfile;
        passwordForm.onsubmit = handleChangePassword;
    }

    // --- [ADMIN PAGE INITIALIZATION] ---
    window.initializeAdminDashboard = () => {
        updateUserStudentCounts();
        const users = Object.values(appState.users).filter(u => u.role === 'school_user');
        const activeUsers = users.filter(u => u.status === 'Active');

        const demoUsers = activeUsers.filter(u => u.plan === 'Demo').length;
        const basicUsers = activeUsers.filter(u => u.plan === 'Basic').length;
        const proUsers = activeUsers.filter(u => u.plan === 'Pro').length;
        const proPlusUsers = activeUsers.filter(u => u.plan === 'Pro Plus').length;
        const inactiveUsers = users.filter(u => u.status === 'Inactive').length;

        document.getElementById('admin-metric-total-users').textContent = users.length;
        document.getElementById('admin-metric-demo-users').textContent = demoUsers;
        document.getElementById('admin-metric-basic-users').textContent = basicUsers;
        document.getElementById('admin-metric-pro-users').textContent = proUsers;
        document.getElementById('admin-metric-pro-plus-users').textContent = proPlusUsers;
        document.getElementById('admin-metric-inactive-users').textContent = inactiveUsers;

        const recentUsers = Object.entries(appState.users)
            .filter(([email, user]) => user.role === 'school_user')
            .sort(([, a], [, b]) => new Date(b.createdAt) - new Date(a.createdAt))
            .slice(0, 5);

        document.getElementById('admin-recent-users-list').innerHTML = recentUsers.map(([email, user]) => `<tr><td class="py-1">${email}</td><td>${user.plan}</td><td>${formatDateTime(user.createdAt)}</td></tr>`).join('');
        
        const chartCtx = document.getElementById('adminSubscriptionChart')?.getContext('2d');
        if (chartCtx) {
            new Chart(chartCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Demo', 'Basic', 'Pro', 'Pro Plus', 'Inactive'],
                    datasets: [{
                        data: [demoUsers, basicUsers, proUsers, proPlusUsers, inactiveUsers],
                        backgroundColor: ['#f59e0b', '#3b82f6', '#7c3aed', '#4f46e5', '#ef4444'],
                        hoverOffset: 4
                    }]
                }
            });
        }
    }
    window.initializeAdminManageUsers = () => {
        updateUserStudentCounts();
        renderUserManagementTable();
    }
    window.initializeAdminSettings = () => {
        document.getElementById('announcement-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            const newAnnouncement = {
                title: form.elements.title.value,
                content: form.elements.content.value,
                type: form.elements.type.value,
            };
            appState.announcements.unshift(newAnnouncement);
            showToast('Announcement posted successfully!');
            form.reset();
        });
    }
    window.initializeAdminAnalytics = () => {
        const chartCtx = document.getElementById('adminUserGrowthChart')?.getContext('2d');
        if (chartCtx) {
            new Chart(chartCtx, {
                type: 'line',
                data: {
                    labels: ['January', 'February', 'March', 'April', 'May'],
                    datasets: [{
                        label: 'New Users',
                        data: [0, 0, 0, 0, 1], 
                        fill: false,
                        borderColor: '#7c3aed',
                        tension: 0.1
                    }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }
    }


    // --- [Data & UI Rendering] ---
    window.renderStudentList = () => {
        const schoolId = document.getElementById('student-school-select').value;
        const className = document.getElementById('student-class-select').value;
        const tableBody = document.getElementById('student-list-body');
        
        const students = appState.students.filter(s => s.schoolId === schoolId && s.className === className);

        if (students.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4">No students found for this class. Click 'Add New Student' to begin.</td></tr>`;
            return;
        }

        tableBody.innerHTML = students.map(s => `
            <tr>
                <td class="p-2"><img src="${s.pictureUrl || 'https://via.placeholder.com/40'}" class="h-10 w-10 rounded-full object-cover"></td>
                <td class="p-2">${s.studentIdCode}</td>
                <td class="p-2 font-medium">${s.name}</td>
                <td class="p-2">${s.className}</td>
                <td class="p-2 space-x-2">
                    <button onclick="showStudentModal('${s.id}')" class="text-blue-600 text-xs hover:underline">Edit</button>
                    <button onclick="deleteStudent('${s.id}')" class="text-red-600 text-xs hover:underline">Delete</button>
                </td>
            </tr>
        `).join('');
    };

        // *** MODIFIED renderReportStudentList ***
    window.renderReportStudentList = () => {
        const schoolId = document.getElementById('report-school-select').value;
        const className = document.getElementById('report-class-select').value;
        const tableBody = document.getElementById('report-student-list');
        
        const students = appState.students.filter(s => s.schoolId === schoolId && s.className === className);

        if (students.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-gray-500">No students found for this selection.</td></tr>`;
            return;
        }

        // Added check for missing data before mapping
        tableBody.innerHTML = students.map(s => {
            // Basic check for essential data
            if (!s || !s.studentIdCode || !s.name || !s.className) {
                console.warn("Skipping rendering student row due to missing data:", s);
                return ''; // Skip this row if data is incomplete
            }
            return `
                <tr>
                    <td class="px-6 py-4">${s.studentIdCode}</td>
                    <td class="px-6 py-4 font-medium">${s.name}</td>
                    <td class="px-6 py-4">${s.className}</td>
                    <td class="px-6 py-4 text-center"> <!-- Changed TD content -->
                        <button onclick="generateReport('${s.studentIdCode}')" class="px-3 py-1 text-xs text-white bg-blue-600 rounded hover:bg-blue-700">
                            Generate Report
                        </button>
                    </td>
                </tr>`;
        }).join(''); // Ensure rows are joined correctly
    };

    window.renderScoresSummary = () => {
        const schoolId = document.getElementById('score-school-select').value;
        const className = document.getElementById('score-class-select').value;
        const classScores = appState.scores.filter(s => s.schoolId === schoolId && s.class_name === className);

        const entryBody = document.querySelector('#assessmentEntryTable tbody');
        if (entryBody) {
             if (classScores.length > 0) {
                entryBody.innerHTML = classScores.slice(0, 10).map(s => `
                <tr data-score-id="${s.id}">
                    <td>${s.student_id_code}</td>
                    <td>${s.name}</td>
                    <td>${s.subject}</td>
                    <td>${s.cat1}-${s.cat2}-${s.cat3}-${s.cat4}</td>
                    <td>${s.exam}</td>
                    <td class="space-x-2 whitespace-nowrap">
                         <button onclick="editScoreOnDataEntry('${s.id}')" class="text-blue-600 text-xs hover:underline">Edit</button>
                         <button onclick="deleteScore('${s.id}')" class="text-red-600 text-xs hover:underline">Delete</button>
                    </td>
                </tr>`).join('');
            } else {
                 entryBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 py-4">No recent entries for this class.</td></tr>`;
            }
        }
        
        const summaryTableBody = document.querySelector('#summaryTable tbody');
        if (!summaryTableBody) return;
        
        const selectedSubject = document.getElementById('summary-subject-select')?.value;
        const summaryTableHeader = document.querySelector('#summaryTable thead tr');

        if (!selectedSubject) {
            summaryTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 py-4">Please select a subject to view the summary.</td></tr>`;
            return;
        }

        if (selectedSubject === "All") {
            if (summaryTableHeader) {
                summaryTableHeader.innerHTML = `<th>ID</th><th>Name</th><th>Subject</th><th>Class Score</th><th>Exams Score</th><th>Total Score</th><th>Subject Position</th>`;
            }

            if (classScores.length === 0) { 
                summaryTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 py-4">No summary to display for this class.</td></tr>`;
                return;
            }

            const processedScores = businessLogic.calculateScoresAndRank(classScores);
            
            summaryTableBody.innerHTML = processedScores.map(s => {
                const pos = businessLogic.getPositionPerSubject(s.student_id_code, s.subject, classScores);
                return `<tr>
                    <td>${s.student_id_code}</td>
                    <td>${s.name}</td>
                    <td>${s.subject}</td>
                    <td>${s.catScaled.toFixed(1)}</td>
                    <td>${s.examScaled.toFixed(1)}</td>
                    <td><b>${s.total.toFixed(1)}</b></td>
                    <td><b>${pos}</b></td>
                </tr>`;
            }).join('');

        } else {
            if (summaryTableHeader) {
                summaryTableHeader.innerHTML = `<th>ID</th><th>Name</th><th>Class Score (50%)</th><th>Exams Score (50%)</th><th>Total (100%)</th><th>Position</th>`;
            }
            
            const subjectScores = classScores.filter(s => s.subject === selectedSubject);
            if (subjectScores.length === 0) {
                summaryTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 py-4">No records found for this subject.</td></tr>`;
                return;
            }
            
            const rankedScores = businessLogic.calculateScoresAndRank(subjectScores);
            summaryTableBody.innerHTML = rankedScores.map(s => `<tr><td>${s.student_id_code}</td><td>${s.name}</td><td>${s.catScaled.toFixed(1)}</td><td>${s.examScaled.toFixed(1)}</td><td><b>${s.total.toFixed(1)}</b></td><td><b>${s.rank}</b></td></tr>`).join('');
        }
    };
    window.renderSchoolList = () => {
        const listDiv = document.getElementById('school-list');
        if (!listDiv) return;
        const userSchools = appState.schools.filter(school => school.createdBy === appState.currentUser);
        if(userSchools.length === 0) {
            listDiv.innerHTML = `<p class="text-gray-500">No schools created yet. Click "Create New School" to begin.</p>`;
            return;
        }
        listDiv.innerHTML = userSchools.map(school => `
            <div class="p-4 border rounded-lg bg-white flex justify-between items-center">
                <div>
                    <div class="flex items-center gap-3">
                        <p class="font-bold">${school.name}</p>
                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${school.type === 'Private' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}">${school.type || 'N/A'}</span>
                    </div>
                    <p class="text-sm text-gray-500">${school.address || 'No address'}</p>
                    <p class="text-xs text-gray-500 mt-1">Classes: ${school.classes.join(', ')}</p>
                </div>
                <div>
                    <button onclick="editSchool(${school.id})" class="text-blue-600 text-sm font-semibold mr-4 hover:underline">Edit</button>
                    <button onclick="deleteSchool(${school.id})" class="text-red-600 text-sm font-semibold hover:underline">Delete</button>
                </div>
            </div>
        `).join('');
    }
    window.renderUserManagementTable = () => {
        const tableBody = document.getElementById('manage-users-table-body');
        if (!tableBody) return;

        let rowsHtml = '';
        for (const email in appState.users) {
            if (appState.users[email].role === 'system_admin') continue; // Skip admin user

            const user = appState.users[email];
            const statusColor = user.status === 'Active' ? 'green' : 'red';

            rowsHtml += `
                <tr class="border-b">
                    <td class="px-4 py-3 font-medium">${email}</td>
                    <td class="px-4 py-3">
                        <select onchange="changeUserPlan('${email}', this.value)" class="p-1 rounded bg-gray-100 border-gray-300 text-xs">
                            <option value="Demo" ${user.plan === 'Demo' ? 'selected' : ''}>Demo</option>
                            <option value="Basic" ${user.plan === 'Basic' ? 'selected' : ''}>Basic</option>
                            <option value="Pro" ${user.plan === 'Pro' ? 'selected' : ''}>Pro</option>
                            <option value="Pro Plus" ${user.plan === 'Pro Plus' ? 'selected' : ''}>Pro Plus</option>
                        </select>
                    </td>
                    <td class="px-4 py-3">
                        <select onchange="toggleAccountStatus('${email}', this.value)" class="p-1 rounded bg-${statusColor}-100 text-${statusColor}-800 border-0 text-xs">
                            <option value="Active" ${user.status === 'Active' ? 'selected' : ''}>Active</option>
                            <option value="Inactive" ${user.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                        </select>
                    </td>
                    <td class="px-4 py-3">${user.studentCount}</td>
                    <td class="px-4 py-3 text-xs whitespace-nowrap">${formatDateTime(user.createdAt)}</td>
                    <td class="px-4 py-3">
                        <button onclick="deleteUser('${email}')" class="text-red-600 hover:underline text-xs">Delete User</button>
                    </td>
                </tr>
            `;
        }
        tableBody.innerHTML = rowsHtml;
    }

    // --- [ADMIN ACTIONS] ---
    window.updateUserStudentCounts = () => {
        const studentCountsByUser = {};

        for (const email in appState.users) {
            if (appState.users[email].role === 'school_user') {
                studentCountsByUser[email] = 0;
            }
        }
        
        appState.students.forEach(student => {
            const school = appState.schools.find(s => s.id == student.schoolId);
            if (school && studentCountsByUser[school.createdBy] !== undefined) {
                studentCountsByUser[school.createdBy]++;
            }
        });
        
        for (const email in studentCountsByUser) {
            appState.users[email].studentCount = studentCountsByUser[email];
        }
    }
    window.toggleAccountStatus = (email, newStatus) => {
        if (appState.users[email]) {
            appState.users[email].status = newStatus;
            renderUserManagementTable();
        }
    }
    window.changeUserPlan = (email, newPlan) => {
        if (appState.users[email]) {
            appState.users[email].plan = newPlan;
            renderUserManagementTable();
        }
    }
    window.deleteUser = (email) => {
        showConfirmationModal(
            `Are you sure you want to delete the user "${email}"? This cannot be undone.`,
            () => {
                if (appState.users[email]) {
                    delete appState.users[email];
                    const userSchools = appState.schools.filter(school => school.createdBy === email);
                    userSchools.forEach(school => {
                        appState.scores = appState.scores.filter(score => score.schoolId != school.id);
                        appState.students = appState.students.filter(student => student.schoolId != school.id);
                    });
                    appState.schools = appState.schools.filter(school => school.createdBy !== email);

                    renderUserManagementTable();
                    showToast('User deleted successfully.');
                }
            }
        );
    }


    // --- [User Actions & Event Handlers] ---
    // *** MODIFIED generateReport function ***
    window.generateReport = (id) => { 
        const scores = appState.scores.filter(s => s.student_id_code === id); 
        if(scores.length === 0) { 
            showToast("No scores found for this student to generate a report.", "error"); 
            return; 
        } 
        const school = appState.schools.find(sc => sc.id == scores[0].schoolId); 
        const settings = school ? school.settings : defaultSettings; 
        
        // Get layout from settings, default to '1' if not set
        const selectedLayout = settings.report_layout || '1'; 

        // Use selectedLayout to choose the function
        const html = selectedLayout === '2' 
                     ? generateReportCardLayout2(id, settings, school) 
                     : generateReportCardLayout1(id, settings, school); 
                     
        document.getElementById('report-card-content').innerHTML = html; 
        document.getElementById('report-modal').classList.remove('hidden'); 
    }
    
    window.downloadReportAsPDF = () => { 
        const user = appState.users[appState.currentUser];
        if (user && user.plan === 'Demo') {
            showToast('Report download is not available on the Demo plan. Please upgrade.', 'error');
            return;
        }
        const el = document.getElementById('report-card-content'); 
        html2pdf().from(el).set({ 
            margin: [0.4, 0.2, 0.4, 0.2], // [top, left, bottom, right]
            filename: `report-card.pdf`, 
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } 
        }).save(); 
    }
    
    window.generateReportCardLayout1 = (studentId, settings, school) => {
        // --- [NEW HTML STRUCTURE FOR LAYOUT 1] ---
        const studentScores = appState.scores.filter(s => s.student_id_code === studentId);
        if (studentScores.length === 0) return `<p>No data found for this student.</p>`;
        
        const userPlan = appState.users[appState.currentUser]?.plan;
        const studentData = appState.students.find(s => s.studentIdCode === studentId);
        const student = studentScores[0];
        
        const { 
            school_name, postal_address, school_tel, term, year, 
            reopening_date, vacation_date, grading_system, 
            head_signature_url, school_crest_url, number_of_open_days, 
            number_on_roll, class_teacher_tel 
        } = settings;

        // --- Calculate Overall Position ---
        const allClassScores = appState.scores.filter(s => s.class_name === student.class_name && s.schoolId === student.schoolId);
        const studentsInClass = {};
        allClassScores.forEach(s => {
            if (!studentsInClass[s.student_id_code]) {
                studentsInClass[s.student_id_code] = { name: s.name, total: 0 };
            }
            const processedScore = businessLogic.calculateScoresAndRank([s])[0];
            studentsInClass[s.student_id_code].total += processedScore.total;
        });

        const rankedClass = Object.entries(studentsInClass)
            .map(([id, data]) => ({ id, ...data }))
            .sort((a, b) => b.total - a.total);

        let classRank = 0, lastTotal = -1, displayRank = 0;
        rankedClass.forEach((stud, index) => {
            if (stud.total !== lastTotal) {
                displayRank = index + 1;
            }
            if (stud.id === studentId) {
                classRank = displayRank;
            }
            lastTotal = stud.total;
        });
        const overallPosition = classRank ? `${classRank}${['st','nd','rd'][((classRank+90)%100-10)%10-1]||'th'}` : '_________________'; // Placeholder if no rank

        let promotionStatus = '_________________'; // Default placeholder
        if (String(term) === '3') {
            const classParts = student.class_name.split(' ');
            if (classParts.length >= 2 && classParts[0].toUpperCase() === 'BS') {
                const currentLevel = parseInt(classParts[1]);
                if (!isNaN(currentLevel) && currentLevel < 9) {
                    promotionStatus = `Promoted to BS ${currentLevel + 1}`; // Or calculate based on average
                } else if (!isNaN(currentLevel) && currentLevel >= 9) {
                     promotionStatus = 'Completed';
                }
            }
        }
        
        const pScores = businessLogic.calculateScoresAndRank(studentScores);
        const totalScoreSum = pScores.reduce((sum, s) => sum + s.total, 0);
        const overallPercent = pScores.length > 0 ? totalScoreSum / pScores.length : 0;
        
        const { core, best } = businessLogic.getCoreAndBestSubjects(pScores);
        const coreAndBestScores = [...core, ...best];
        const rawScore4Core2Best = coreAndBestScores.reduce((sum, s) => sum + s.total, 0);
        const bestSixSubjectsAggregate = 0; // Placeholder - Aggregate calculation needs clarification

        const bestSub = pScores.reduce((b, c) => c.total > b.total ? c : b, {total: -1}).subject;
        
        const termMap = {'1': '1ST TERM', '2': '2ND TERM', '3': '3RD TERM'};
        const formattedTerm = termMap[term] || `${term} TERM`;

        const rows = pScores.map(s => {
            const { grade, remarks } = businessLogic.getGradeAndRemarks(s.total, grading_system); // Use selected grading system
            const pos = businessLogic.getPositionPerSubject(s.student_id_code, s.subject, allClassScores);
            return `
                <tr>
                    <td class="subject-col">${s.subject}</td>
                    <td>${s.catScaled.toFixed(0)}</td>
                    <td>${s.examScaled.toFixed(0)}</td>
                    <td>${s.total.toFixed(0)}</td>
                    <td>${pos}</td>
                    <td>${grade}</td>
                    <td>${remarks}</td>
                </tr>`;
        }).join('');
        
        // --- Define Grading Interpretation based on selected system ---
        let gradeInterpretationHtml = '';
        if (grading_system === '1') {
            gradeInterpretationHtml = `
                <div>A = EXCELLENT</div><div>B+ = VERY GOOD</div><div>B = GOOD</div>
                <div>C+ = CREDIT</div><div>C = AVERAGE</div><div>D+ = PASS</div>
                <div>D = WEAK PASS</div><div>E = VERY WEAK PASS</div><div>F = FAIL</div>
            `;
        } else if (grading_system === '2') {
             gradeInterpretationHtml = `
                <div>1 = HIGHEST</div><div>2 = HIGHER</div><div>3 = HIGH</div>
                <div>4 = HIGH AVERAGE</div><div>5 = AVERAGE</div><div>6 = LOW AVERAGE</div>
                <div>7 = LOW</div><div>8 = LOWER</div><div>9 = LOWEST</div>
            `;
        } else if (grading_system === '3') {
             gradeInterpretationHtml = `
                <div>HP = HIGHLY PROFICIENT</div><div>P = PROFICIENT</div>
                <div>AP = APPROACHING PROFICIENT</div><div>D = DEVELOPING</div><div>E = EMERGING</div>
            `;
        }


       return `
       <style>
             /* Styles specific to Layout 1, mimicking the provided structure */
            .report-card-l1 * { margin: 0; padding: 0; box-sizing: border-box; }
            .report-card-l1 body { font-family: "Times New Roman", Times, serif; padding: 5px; /* Reduced padding */ background: #f4f4f4; }
            .report-card-l1 .report-card { width: 100%; /* Use full width */ margin: 0 auto; background: white; border: 3px solid #333; padding: 10px; /* Reduced padding */ position: relative; }
            .report-card-l1 .report-card::before { 
                 content: ""; 
                 background-image: url('${(userPlan === 'Pro Plus' && school_crest_url) ? school_crest_url : ''}'); /* Use crest URL if Pro Plus */
                 background-repeat: no-repeat;
                 background-position: center;
                 background-size: 300px;
                 position: absolute;
                 top: 50%; left: 50%;
                 transform: translate(-50%, -50%) rotate(0deg); /* No rotation for watermark */
                 opacity: ${(userPlan === 'Pro Plus' && school_crest_url) ? '0.08' : '0'}; /* Show only if Pro Plus and crest exists */
                 pointer-events: none;
                 z-index: 0;
                 width: 100%; height: 100%;
            }
            .report-card-l1 .header { text-align: center; margin-bottom: 10px; /* Reduced margin */ position: relative; z-index: 1; padding-left: calc(3cm + 5px); /* Reduced gap */ padding-right: calc(3cm + 5px); /* Reduced gap */ min-height: 3.5cm; display: flex; align-items: center; justify-content: center; }
            .report-card-l1 .header h2 { font-size: 16pt; font-weight: bold; margin: 1px 0; color: #004a99; }
            .report-card-l1 .header h3 { font-size: 14pt; font-weight: bold; margin: 1px 0; color: #004a99; }
            .report-card-l1 .header p { font-size: 10pt; margin: 0px 0; }
            .report-card-l1 .student-details { display: flex; gap: 10px; /* Reduced gap */ margin-bottom: 10px; /* Reduced margin */ position: relative; z-index: 1; }
            .report-card-l1 .photo-box { width: 3cm; height: 3.5cm; border: 1px solid #333; display: flex; align-items: center; justify-content: center; text-align: center; color: #888; font-size: 10pt; background: #f9f9f9; position: absolute; left: 0; top: 50%; transform: translateY(-50%); }
            .report-card-l1 .photo-box img { width: 100%; height: 100%; object-fit: cover; }
            .report-card-l1 .logo-box { width: 3cm; height: 3.5cm; border: 1px solid #333; display: flex; align-items: center; justify-content: center; text-align: center; color: #888; font-size: 10pt; background: #f9f9f9; position: absolute; right: 0; top: 50%; transform: translateY(-50%); }
             .report-card-l1 .logo-box img { width: 100%; height: 100%; object-fit: contain; /* Use contain for logo */ }
            .report-card-l1 .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0; font-size: 10pt; flex: 1; border: 1px solid #333; }
            .report-card-l1 .info-row { display: flex; padding: 4px; /* Reduced padding */ border-bottom: 1px solid #333; }
            .report-card-l1 .info-grid .info-row:nth-child(odd) { border-right: 1px solid #333; }
            .report-card-l1 .info-grid .info-row:nth-last-child(1), .report-card-l1 .info-grid .info-row:nth-last-child(2) { border-bottom: none; }
            .report-card-l1 .info-label { font-weight: bold; margin-right: 5px; min-width: 100px; /* Adjusted min-width */ white-space: nowrap; }
            .report-card-l1 .info-data { font-weight: normal; }
            .report-card-l1 table { width: 100%; border-collapse: collapse; margin-bottom: 10px; /* Reduced margin */ font-size: 10pt; position: relative; z-index: 1; }
            .report-card-l1 th, .report-card-l1 td { border: 1px solid #333; padding: 4px; /* Reduced padding */ text-align: center; vertical-align: middle; } /* Added vertical align */
            .report-card-l1 thead th { background: #e0eef9; font-weight: bold; font-size: 9pt; /* Smaller header font */ }
            .report-card-l1 .subject-col { text-align: left; padding-left: 5px; font-weight: normal; font-size: 10pt; /* Reduced subject font size */ text-transform: uppercase; }
            .report-card-l1 tbody td { height: 25px; /* Reduced row height */ font-size: 10pt; } /* Ensure consistent font size */
             /* Removed alternating background colors */
            .report-card-l1 tfoot td { font-weight: bold; text-align: left; padding: 4px; background: #e0eef9; font-size: 9pt; }
            .report-card-l1 .bottom-section { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; /* Reduced gap */ margin-bottom: 10px; /* Reduced margin */ font-size: 10pt; position: relative; z-index: 1; }
            .report-card-l1 .bottom-item { padding: 1px 0; /* Reduced padding */ }
            .report-card-l1 .remarks-signature-wrapper { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; /* Reduced margin */ gap: 10px; }
            .report-card-l1 .remarks-box { border: 1px solid #333; padding: 5px; min-height: 40px; /* Reduced height */ font-size: 10pt; position: relative; z-index: 1; flex: 1; }
            .report-card-l1 .teacher-tel { font-size: 10pt; margin-bottom: 10px; /* Reduced margin */ position: relative; z-index: 1; }
            .report-card-l1 .grade-legend { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); /* Adjusted minmax */ gap: 3px; border: 1px solid #333; padding: 5px; /* Reduced padding */ margin-bottom: 10px; /* Reduced margin */ font-size: 8pt; /* Reduced font size */ position: relative; z-index: 1; }
            .report-card-l1 .grade-legend-title { grid-column: 1 / -1; font-weight: bold; margin-bottom: 3px; text-align: center; background: #e0eef9; padding: 3px; font-size: 9pt; }
            .report-card-l1 .signature-section { font-size: 10pt; position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; }
             .report-card-l1 .signature-image { max-height: 35px; /* Limit signature height */ margin-bottom: -5px; } /* Adjust margin */
            .report-card-l1 .signature-line { margin-bottom: 3px; border-top: 1px solid #333; width: 150px; /* Fixed width line */ margin-top: 5px; /* Add space above line */ }
            .report-card-l1 .footer { display: flex; justify-content: space-between; border-top: 2px solid #333; padding: 5px; /* Reduced padding */ font-size: 8pt; /* Reduced font size */ position: relative; z-index: 1; background: #d0dfee; }
        </style>
        <div class="report-card-l1">
            <div class="report-card">
                <div class="header">
                    <div class="photo-box">
                       ${userPlan === 'Pro Plus' && studentData?.pictureUrl ? `<img src="${studentData.pictureUrl}" alt="Student Photo">` : `Photo`}
                    </div>
                    <div class="logo-box">
                         ${['Pro', 'Pro Plus'].includes(userPlan) && school_crest_url ? `<img src="${school_crest_url}" alt="School Logo">` : `Logo`}
                    </div>
                    <div>
                        <h2>GHANA EDUCATION SERVICE</h2>
                        <h3>${school_name || 'SCHOOL NAME'}</h3>
                        <p>${postal_address || 'P.O. BOX ADDRESS'}</p>
                        <p>${school_tel || 'SCHOOL TEL'}</p>
                        <h3>STUDENT'S TERMINAL REPORT</h3>
                    </div>
                </div>
                
                <div class="student-details">
                    <div class="info-grid">
                        <div class="info-row">
                            <span class="info-label">STUDENT ID:</span>
                            <span class="info-data">${studentId}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">CLASS:</span>
                            <span class="info-data">${student.class_name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">NAME OF STUDENT:</span>
                            <span class="info-data">${student.name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">YEAR:</span>
                            <span class="info-data">${year}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">TERM:</span>
                            <span class="info-data">${formattedTerm}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">POSITION:</span>
                            <span class="info-data">${overallPosition}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">No. ON ROLL:</span>
                            <span class="info-data">${number_on_roll || ''}</span>
                        </div>
                         <div class="info-row">
                            <span class="info-label">RE-OPENING DATE:</span>
                           <span class="info-data">${reopening_date ? new Date(reopening_date+'T00:00:00').toLocaleDateString('en-GB', {day: '2-digit', month: 'long', year: 'numeric'}).toUpperCase() : ''}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">VACATION DATE:</span>
                            <span class="info-data">${vacation_date ? new Date(vacation_date+'T00:00:00').toLocaleDateString('en-GB', {day: '2-digit', month: 'long', year: 'numeric'}).toUpperCase() : ''}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">PROMOTION STATUS:</span>
                            <span class="info-data">${promotionStatus}</span>
                        </div>
                    </div>
                </div>
                
                <table>
                    <colgroup> <col style="width: 25%;"> <col style="width: 10%;"> <col style="width: 10%;"> <col style="width: 12%;"> <col style="width: 10%;"> <col style="width: 10%;"> <col style="width: 23%;"> </colgroup>
                    <thead>
                        <tr>
                            <th>SUBJECT</th> <th>CLASS SCORE<br>50</th> <th>EXAMS SCORE<br>50</th> <th>TOTAL SCORE<br>100%</th> <th>POSITION</th> <th>GRADE</th> <th>REMARKS</th>
                        </tr>
                    </thead>
                    <tbody>
                       ${rows}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td class="subject-col" colspan="3">RAW SCORE FOR THE 4CORE+2BEST</td>
                            <td style="text-align: center;">${rawScore4Core2Best.toFixed(1)}</td>
                            <td style="text-align: right;" colspan="2">TOTAL SCORE: ${totalScoreSum.toFixed(1)}</td>
                            <td style="text-align: center;">OUT OF ${pScores.length * 100}</td>
                        </tr>
                    </tfoot>
                </table>
                
                <div class="bottom-section">
                    <div>
                        <div class="bottom-item"><strong>BEST SIX SUBJECTS AGGREGATE:</strong> ${bestSixSubjectsAggregate > 0 ? bestSixSubjectsAggregate : '_________'}</div>
                        <div class="bottom-item"><strong>THE 4 CORE + 2 BEST SUBJECTS:</strong> ${rawScore4Core2Best > 0 ? rawScore4Core2Best.toFixed(1) : '_________'}</div>
                    </div>
                    <div>
                        <div class="bottom-item"><strong>ATTENDANCE:</strong> _________ <strong>Out of</strong> ${number_of_open_days || ''}</div>
                        <div class="bottom-item"><strong>INTEREST:</strong> <span style="font-size: 11pt; text-transform: uppercase;">${businessLogic.getInterest(bestSub)}</span></div>
                        <div class="bottom-item"><strong>ATTITUDE:</strong> <span style="font-size: 11pt; text-transform: uppercase;">${businessLogic.getAttitudeRemark(overallPercent)}</span></div>
                    </div>
                </div>
                
                <div class="remarks-signature-wrapper">
                    <div class="remarks-box">
                        <strong>CLASS TEACHER'S REMARKS:</strong>
                        <span style="margin-left: 5px; font-size: 11pt; text-transform: uppercase;">${businessLogic.getTeacherRemark(overallPercent)}</span>
                    </div>
                    <div class="signature-section">
                         ${head_signature_url ? `<img src="${head_signature_url}" class="signature-image">` : '<div style="height: 35px;"></div>'}
                        <div class="signature-line"></div>
                        <strong>HEADTEACHER'S SIGNATURE</strong>
                    </div>
                </div>

                <div class="teacher-tel">
                    <strong>CLASS/FORM TEACHER TEL NO:</strong> ${class_teacher_tel || '_________________'}
                </div>
                
                <div class="grade-legend">
                    <div class="grade-legend-title">GRADE INTERPRETATION</div>
                    ${gradeInterpretationHtml}
                </div>
                
                <div class="footer">
                    <span><strong>${formattedTerm} TERMINAL REPORT</strong></span>
                    <span><strong>ANY ERASURE MAKES IT INVALID</strong></span>
                    <span>SbaHub tel 0533299769</span>
                </div>
            </div>
        </div>
        `;
    };

    window.generateReportCardLayout2 = (studentId, settings, school) => {
        const studentScores = appState.scores.filter(s => s.student_id_code === studentId);
        if (studentScores.length === 0) return `<p>No data found for this student.</p>`;
        
        const userPlan = appState.users[appState.currentUser]?.plan;
        const studentData = appState.students.find(s => s.studentIdCode === studentId);

        const student = studentScores[0];
        const { 
            school_name, postal_address, school_tel, term, year, reopening_date, vacation_date, 
            head_signature_url, school_crest_url, number_of_open_days, 
            number_on_roll, class_teacher_tel 
        } = settings;

        const allClassScores = appState.scores.filter(s => s.class_name === student.class_name && s.schoolId === student.schoolId);
        const studentsInClass = {};
        allClassScores.forEach(s => {
            if (!studentsInClass[s.student_id_code]) {
                studentsInClass[s.student_id_code] = { name: s.name, total: 0 };
            }
            const processedScore = businessLogic.calculateScoresAndRank([s])[0];
            studentsInClass[s.student_id_code].total += processedScore.total;
        });

        const rankedClass = Object.entries(studentsInClass)
            .map(([id, data]) => ({ id, ...data }))
            .sort((a, b) => b.total - a.total);

        let classRank = 0, lastTotal = -1, displayRank = 0;
        rankedClass.forEach((stud, index) => {
            if (stud.total !== lastTotal) {
                displayRank = index + 1;
            }
            if (stud.id === studentId) {
                classRank = displayRank;
            }
            lastTotal = stud.total;
        });
        const overallPosition = classRank ? `${classRank}${['st','nd','rd'][((classRank+90)%100-10)%10-1]||'th'}` : 'N/A';

        let promotedTo = 'N/A';
        if (String(term) === '3') {
            const classParts = student.class_name.split(' ');
            if (classParts.length >= 2 && classParts[0].toUpperCase() === 'BS') {
                const currentLevel = parseInt(classParts[1]);
                if (!isNaN(currentLevel) && currentLevel < 9) {
                    promotedTo = `BS ${currentLevel + 1}`;
                }
            }
        }

        const pScores = businessLogic.calculateScoresAndRank(studentScores);
        const totalScore = pScores.reduce((sum, s) => sum + s.total, 0);
        const overallPercent = pScores.length > 0 ? totalScore / pScores.length : 0;
        const bestSub = pScores.reduce((b, c) => c.total > b.total ? c : b, {total: -1}).subject;
        const gradeSystemForLayout2 = '2';

        const scoreRows = pScores.map(s => {
            const { grade } = businessLogic.getGradeAndRemarks(s.total, gradeSystemForLayout2);
            const { remarks } = businessLogic.getGradeAndRemarks(s.total, '1');
            const pos = businessLogic.getPositionPerSubject(s.student_id_code, s.subject, allClassScores);
            return `
                <tr>
                    <td style="border: 1px solid black; padding: 3px; text-align: left;">${s.subject}</td>
                    <td style="border: 1px solid black; padding: 3px; text-align: center;">${s.catScaled.toFixed(0)}</td>
                    <td style="border: 1px solid black; padding: 3px; text-align: center;">${s.examScaled.toFixed(0)}</td>
                    <td style="border: 1px solid black; padding: 3px; text-align: center;">${s.total.toFixed(0)}</td>
                    <td style="border: 1px solid black; padding: 3px; text-align: center;">${pos}</td>
                    <td style="border: 1px solid black; padding: 3px; text-align: center;">${grade}</td>
                    <td style="border: 1px solid black; padding: 3px; text-align: left;">${remarks}</td>
                </tr>`;
        }).join('');

        const isPublicSchool = school && school.type === 'Public';
        const headerContent = isPublicSchool
            ? `<div style="text-align: center; flex-grow: 1;">
                            <h2 style="font-weight: bold; font-size: 16px; margin: 0; padding: 0;">GHANA EDUCATION SERVICE</h2>
                            <h3 style="font-weight: bold; font-size: 20px; margin: 2px 0;">${school_name || ''}</h3>
                            <p style="font-size: 12px; margin: 0;">${postal_address || ''}</p>
                            <p style="font-size: 12px; margin: 0;">TEL: ${school_tel || ''}</p>
                        </div>`
            : `<div style="text-align: center; flex-grow: 1;">
                            <h3 style="font-weight: bold; font-size: 20px; margin: 2px 0;">${school_name || ''}</h3>
                            <p style="font-size: 12px; margin: 0;">${postal_address || ''}</p>
                            <p style="font-size: 12px; margin: 0;">TEL: ${school_tel || ''}</p>
                        </div>`;

        return `
        <div style="border: 2px solid black; padding: 2px; font-family: Arial, sans-serif; color: black; background-color: white;">
            <div style="border: 1px solid black; padding: 15px; position: relative;">
                
                ${userPlan === 'Pro Plus' && school_crest_url ? `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.08; z-index: 0;"><img src="${school_crest_url}" style="width: 400px; height: auto;"></div>` : ''}
                
                <div style="position: relative; z-index: 1;">
                    
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            ${['Pro', 'Pro Plus'].includes(userPlan) && school_crest_url ? `
                                <img src="${school_crest_url}" style="width: 80px; height: 80px;">
                            ` : `
                                <div style="width: 80px; height: 80px;"></div>
                            `}
                        </div>
                        ${headerContent}
                        <div>
                            ${userPlan === 'Pro Plus' && studentData?.pictureUrl ? `
                                <img src="${studentData.pictureUrl}" style="width: 80px; height: 80px; object-fit: cover; border: 1px solid black;">
                            ` : `
                                <div style="width: 80px; height: 80px;"></div>
                            `}
                        </div>
                    </div>
                    <div style="text-align: center; font-weight: bold; font-size: 14px; padding: 2px; border-top: 2px solid black; border-bottom: 2px solid black; margin: 10px 0;">
                        STUDENT TERMINAL REPORT
                    </div>

                    <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
                        <tbody>
                            <tr>
                                <td style="padding: 2px 0; white-space: nowrap;"><strong>STUDENT ID:</strong></td>
                                <td style="border-bottom: 1px solid black; width: 30%; padding: 0 5px;">${student.student_id_code}</td>
                                <td style="padding: 2px 0 2px 15px; white-space: nowrap;"><strong>CLASS:</strong></td>
                                <td style="border-bottom: 1px solid black; width: 30%; padding: 0 5px;">${student.class_name}</td>
                            </tr>
                            <tr>
                                <td style="padding: 2px 0; white-space: nowrap;"><strong>NAME OF STUDENT:</strong></td>
                                <td style="border-bottom: 1px solid black; padding: 0 5px;">${student.name}</td>
                                <td style="padding: 2px 0 2px 15px; white-space: nowrap;"><strong>YEAR:</strong></td>
                                <td style="border-bottom: 1px solid black; padding: 0 5px;">${year}</td>
                            </tr>
                            <tr>
                                <td style="padding: 2px 0; white-space: nowrap;"><strong>TERM:</strong></td>
                                <td style="border-bottom: 1px solid black; padding: 0 5px;">${term}</td>
                                 <td style="padding: 2px 0 2px 15px; white-space: nowrap;"><strong>POSITION:</strong></td>
                                <td style="border-bottom: 1px solid black; padding: 0 5px;">${overallPosition}</td>
                            </tr>
                             <tr>
                                <td style="padding: 2px 0; white-space: nowrap;"><strong>No. ON ROLL:</strong></td>
                                <td style="border-bottom: 1px solid black; padding: 0 5px;">${number_on_roll}</td>
                                <td style="padding: 2px 0 2px 15px; white-space: nowrap;"><strong>RE-OPENING DATE:</strong></td>
                                <td style="border-bottom: 1px solid black; padding: 0 5px;">${reopening_date ? new Date(reopening_date+'T00:00:00').toLocaleDateString('en-GB') : ''}</td>
                            </tr>
                             <tr>
                                <td style="padding: 2px 0; white-space: nowrap;"><strong>VACATION DATE:</strong></td>
                                <td style="border-bottom: 1px solid black; padding: 0 5px;">${vacation_date ? new Date(vacation_date+'T00:00:00').toLocaleDateString('en-GB') : ''}</td>
                                <td style="padding: 2px 0 2px 15px; white-space: nowrap;"><strong>PROMOTED TO:</strong></td>
                                <td style="border-bottom: 1px solid black; padding: 0 5px;">${promotedTo}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <table style="width: 100%; font-size: 11px; border-collapse: collapse; margin-top: 10px; text-transform: uppercase;">
                        <thead style="font-weight: bold;">
                            <tr>
                                <th style="border: 1px solid black; padding: 4px; text-align: left;">SUBJECT</th>
                                <th style="border: 1px solid black; padding: 4px; text-align: center;">CLASS SCORE 50</th>
                                <th style="border: 1px solid black; padding: 4px; text-align: center;">EXAMS SCORE 50</th>
                                <th style="border: 1px solid black; padding: 4px; text-align: center;">TOTAL SCORE 100%</th>
                                <th style="border: 1px solid black; padding: 4px; text-align: center;">POSITION</th>
                                <th style="border: 1px solid black; padding: 4px; text-align: center;">GRADE</th>
                                <th style="border: 1px solid black; padding: 4px; text-align: left;">REMARKS</th>
                            </tr>
                        </thead>
                        <tbody>${scoreRows}</tbody>
                    </table>
                    
                    <div style="border: 1px solid black; padding: 5px; text-align: center; font-weight: bold; margin-top: 5px; font-size: 12px;">
                        TOTAL SCORE &nbsp;&nbsp;&nbsp; ${totalScore.toFixed(0)} &nbsp;&nbsp;&nbsp; Out Of &nbsp;&nbsp;&nbsp; ${pScores.length * 100}
                    </div>
                    
                    <div style="display: flex; margin-top: 5px; font-size: 12px; align-items: stretch;">
                        <div style="width: 65%; border: 1px solid black; padding: 5px;">
                            <p style="margin: 2px 0;"><strong>ATTENDANCE:</strong> &nbsp; <span style="display: inline-block; border: 1px solid black; padding: 2px 20px;">____</span> &nbsp; Out of &nbsp; <span style="display: inline-block; border: 1px solid black; padding: 2px 20px;">${number_of_open_days}</span></p>
                            <p style="margin: 8px 0;"><strong>INTEREST:</strong> ${businessLogic.getInterest(bestSub)}</p>
                            <p style="margin: 8px 0;"><strong>ATTITUDE:</strong> ${businessLogic.getAttitudeRemark(overallPercent)}</p>
                            <p style="margin: 8px 0;"><strong>CLASS TEACHER'S REMARKS:</strong> ${businessLogic.getTeacherRemark(overallPercent)}</p>
                        </div>
                        <div style="width: 35%; text-align: center; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-left: 10px;">
                            <div style="margin-bottom: 2px; height: 40px;">
                                 ${head_signature_url ? `<img src="${head_signature_url}" style="height: 40px; max-width: 150px;">` : ''}
                            </div>
                            <div style="border-top: 1px solid black; font-size: 11px; padding-top: 2px; width: 80%;">HEADTEACHER'S SIGNATURE</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: flex-end; font-size: 10px;">
                         <div style="width: 65%;">
                            <p style="font-size: 11px; margin:0 0 5px 0;"><strong>${term}RD TERM/TERMINAL REPORT</strong> &nbsp; ANY ERASURE RENDERS THIS INVALID</p>
                            <table style="font-size: 9px; border-collapse: collapse; border: 1px solid black;">
                                <tbody>
                                    <tr style="font-weight: bold;"><td colspan="4" style="border: 1px solid black; padding: 1px 3px; text-align: center;">GRADE INTERPRETATION</td></tr>
                                    <tr>
                                        <td style="border: 1px solid black; padding: 1px 3px;">A= EXCELLENT</td><td style="border: 1px solid black; padding: 1px 3px;">C+=CREDIT</td>
                                        <td style="border: 1px solid black; padding: 1px 3px;">D= WEAK PASS</td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid black; padding: 1px 3px;">B+=VERY GOOD</td><td style="border: 1px solid black; padding: 1px 3px;">C= AVERAGE</td>
                                        <td style="border: 1px solid black; padding: 1px 3px;">E= VERY WEAK PASS</td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid black; padding: 1px 3px;">B= GOOD</td><td style="border: 1px solid black; padding: 1px 3px;">D+= PASS</td>
                                        <td style="border: 1px solid black; padding: 1px 3px;">F= FAIL</td>
                                    </tr>
                                </tbody>
                             </table>
                         </div>
                         <div style="font-size: 11px; font-weight: bold; text-align: right;">
                             SpyCode - TEL: ${class_teacher_tel || 'N/A'}
                         </div>
                    </div>
                </div>
            </div>
        </div>
        `;
    };

    window.handleAddScore = async (e) => {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const selectedSchool = document.getElementById('score-school-select').value;
        const selectedClass = document.getElementById('score-class-select').value;
        formData.append('schoolId', selectedSchool);
        formData.append('class_name', selectedClass);
        formData.append('term', appState.settings.term);
        formData.append('academic_year', appState.settings.year);

        const scoreId = form.elements.scoreId.value;
        const action = scoreId ? 'updated' : 'added';

        try {
            const result = await apiCall('scores.php', 'POST', formData);
            if (result.status === 'success') {
                clearAssessmentForm();
                await fetchInitialData();
                renderScoresSummary();
                renderRawScoreSheet();
                showToast(`Score ${action} successfully.`);
            } else {
                showToast('Error: ' + result.message, 'error');
            }
        } catch (error) {
            console.error(`Failed to ${action} score:`, error);
        }
    }

    window.editScoreOnDataEntry = (scoreId) => {
        const score = appState.scores.find(s => s.id == scoreId);
        if (!score) return;

        const form = document.getElementById('assessmentEntryForm');
        form.elements.scoreId.value = score.id;
        form.elements.student_id_code.value = score.student_id_code;
        form.elements.subject.value = score.subject;
        form.elements.cat1.value = score.cat1;
        form.elements.cat2.value = score.cat2;
        form.elements.cat3.value = score.cat3;
        form.elements.cat4.value = score.cat4;
        form.elements.exam.value = score.exam;

        form.querySelector('button[type="submit"]').textContent = 'Update Record';
    }

    window.clearAssessmentForm = () => {
        const form = document.getElementById('assessmentEntryForm');
        form.reset();
        form.elements.scoreId.value = '';
        form.querySelector('button[type="submit"]').textContent = 'Add Record';
    }


    window.handleSaveSettings = async (e) => { e.preventDefault(); const form = e.target; const schoolId = document.getElementById('settings-school-select').value; const school = appState.schools.find(s => s.id == schoolId); if (!school) return showToast('Please select a school first.', 'error'); const newSettings = {}; for(const key in defaultSettings) { if (form.elements[key] && form.elements[key].type !== 'file') { newSettings[key] = form.elements[key].value; } else { newSettings[key] = school.settings[key]; } } const signatureFile = form.elements['head_signature_file'].files[0]; const crestFile = form.elements['school_crest_file'].files[0]; try { if (signatureFile) { const fd = new FormData(); fd.append('file', signatureFile); const res = await apiCall('upload.php', 'POST', fd); newSettings.head_signature_url = res.filePath; } if (crestFile) { const fd = new FormData(); fd.append('file', crestFile); const res = await apiCall('upload.php', 'POST', fd); newSettings.school_crest_url = res.filePath; } school.settings = newSettings; showToast('Settings saved for ' + school.name); } catch(error) { console.error('Failed to save settings:', error); showToast('Error saving settings.', 'error'); } }
    window.handleExcelUpload = async (event, subject) => {
        event.preventDefault();
        const form = event.target;
        const fileInput = form.elements.excel_file;
        const file = fileInput.files[0];
        const statusDiv = form.querySelector('.upload-status');
        const selectedSchool = document.getElementById('score-school-select').value;
        const selectedClass = document.getElementById('score-class-select').value;
        
        if (!subject) { showToast('An error occurred. Subject not specified.', 'error'); return; }
        if (!file) { statusDiv.textContent = 'Please select a file.'; return; } 

        const schoolName = document.getElementById('score-school-select').options[document.getElementById('score-school-select').selectedIndex].text.replace(/ /g, '_');
        const className = selectedClass.replace(/ /g, '_');
        const formattedSubjectName = subject.replace(/ /g, '_');
        const expectedFileName = `${schoolName}_${className}_${formattedSubjectName}_Template.xlsx`;

        if (file.name !== expectedFileName) {
            statusDiv.innerHTML = `<span class="text-red-600">Error: Incorrect file. Please upload "${expectedFileName}".</span>`;
            fileInput.value = '';
            return;
        }
        
        statusDiv.textContent = 'Processing...'; 
        const reader = new FileReader(); 
        reader.onload = async (e) => { 
            try { 
                const data = new Uint8Array(e.target.result); 
                const workbook = XLSX.read(data, { type: 'array' }); 
                const sheetName = workbook.SheetNames[0]; 
                const worksheet = workbook.Sheets[sheetName]; 
                const json = XLSX.utils.sheet_to_json(worksheet); 
                if (json.length === 0) { statusDiv.textContent = 'Error: Excel sheet is empty or has an invalid format.'; return; } 
                for (const row of json) { 
                    const formData = new FormData(); 
                    
                    let student = appState.students.find(s => s.name.toLowerCase() === row.Name.toLowerCase() && s.schoolId === selectedSchool && s.className === selectedClass);
                    if (!student) {
                        console.warn(`Student "${row.Name}" not found in Manage Students. Skipping score entry.`);
                        continue;
                    }

                    formData.append('student_id_code', student.studentIdCode);
                    formData.append('class_name', selectedClass); 
                    formData.append('subject', subject); 
                    formData.append('schoolId', selectedSchool); 
                    formData.append('cat1', row.CAT1); 
                    formData.append('cat2', row.CAT2); 
                    formData.append('cat3', row.CAT3); 
                    formData.append('cat4', row.CAT4); 
                    formData.append('exam', row.Exam); 
                    await apiCall('scores.php', 'POST', formData); 
                } 
                statusDiv.innerHTML = `<span class="text-green-600">Successfully uploaded records!</span>`; 
                form.reset();
                await fetchInitialData(); 
                renderScoresSummary(); 
                renderRawScoreSheet(); 
            } catch (error) { 
                statusDiv.textContent = 'Error processing file. See console for details.'; 
                console.error(error); 
            } 
        }; 
        reader.readAsArrayBuffer(file); 
    }
    window.fetchInitialData = async () => { try { const scoresData = await apiCall('scores.php'); if (scoresData.status === 'success') appState.scores = scoresData.data; } catch (error) { console.error(error); } }
    
    window.handleSignup = () => { 
        const fullName = document.querySelector('#signup-page input[type="text"]').value;
        const email = document.getElementById('signup-email').value; 
        if (!email || !fullName) { 
            showToast('Please enter your full name and email.', 'error'); 
            return; 
        } 
        if (appState.users[email]) { 
            showToast('An account with this email already exists.', 'error');
            return; 
        } 
        appState.users[email] = { role: 'school_user', plan: 'Demo', status: 'Active', studentCount: 0, createdAt: new Date().toISOString(), name: fullName, pictureUrl: null }; 
        login('school_user', email); 
    }

    window.handleBulkDownload = () => {
        const user = appState.users[appState.currentUser];
        if (['Basic', 'Pro', 'Pro Plus'].includes(user?.plan)) {
            const modal = document.getElementById('bulk-download-modal');
            const schoolSelect = document.getElementById('bulk-school-select');
            const classSelect = document.getElementById('bulk-class-select');
            const form = document.getElementById('bulk-download-form');

            schoolSelect.innerHTML = '<option value="">-- Select School --</option>' + appState.schools.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            classSelect.innerHTML = '<option value="">-- Select School First --</option>';
            classSelect.disabled = true;

            schoolSelect.onchange = () => {
                const school = appState.schools.find(s => s.id == schoolSelect.value);
                if (school) {
                    classSelect.innerHTML = '<option value="">-- Select Class --</option>' + school.classes.map(c => `<option value="${c}">${c}</option>`).join('');
                    classSelect.disabled = false;
                } else {
                    classSelect.innerHTML = '<option value="">-- Select School First --</option>';
                    classSelect.disabled = true;
                }
            };

            form.onsubmit = (e) => {
                e.preventDefault();
                processBulkDownload();
            };

            modal.classList.remove('hidden');

        } else {
            showToast('Bulk Download is a Pro feature. Please upgrade your plan.', 'info');
        }
    };
    window.hideBulkDownloadModal = () => {
        document.getElementById('bulk-download-modal').classList.add('hidden');
    }
    window.processBulkDownload = () => {
        const schoolId = document.getElementById('bulk-school-select').value;
        const className = document.getElementById('bulk-class-select').value;
        const layout = parseInt(document.getElementById('bulk-layout-select').value);

        if (!schoolId || !className) {
            showToast('Please select a school and class.', 'error');
            return;
        }

        showToast('Generating bulk report... This may take a moment.', 'info');
        hideBulkDownloadModal();

        const studentsToPrint = appState.students.filter(s => s.schoolId == schoolId && s.className == className);

        if (studentsToPrint.length === 0) {
            showToast('No student data available for the selected class.', 'info');
            return;
        }

        const bulkContainer = document.createElement('div');
        studentsToPrint.forEach(student => {
            const school = appState.schools.find(sc => sc.id == student.schoolId);
            const settings = school ? school.settings : defaultSettings;
            // Use the selected layout from the modal for bulk download
            const reportHtml = layout === 2 
                             ? generateReportCardLayout2(student.studentIdCode, settings, school) 
                             : generateReportCardLayout1(student.studentIdCode, settings, school);
            
            const pageWrapper = document.createElement('div');
            pageWrapper.style.pageBreakAfter = 'always'; 
            pageWrapper.innerHTML = reportHtml;
            bulkContainer.appendChild(pageWrapper);
        });

        const schoolName = appState.schools.find(s => s.id == schoolId).name.replace(/ /g, '_');
        const fileName = `SbaHub_${schoolName}_${className.replace(/ /g, '_')}_Reports.pdf`;

        const opt = {
            margin:       [0.4, 0.2, 0.4, 0.2],
            filename:     fileName,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2 },
            jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().from(bulkContainer).set(opt).save().then(() => {
            showToast('Bulk report download complete!');
        });
    }
    window.selectPlan = (el, planName, amount) => {
        document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('payment-details').classList.remove('hidden');
        
        selectedPlan = { name: planName, amount: amount };
        const totalAmount = amount.toFixed(2);
        
        document.getElementById('total-amount').textContent = totalAmount;
        document.getElementById('momo-amount').textContent = totalAmount;
        document.getElementById('card-amount').textContent = totalAmount;
    }
    window.showPaymentForm = (type) => { document.getElementById('momo-form').style.display = type === 'momo' ? 'block' : 'none'; document.getElementById('card-form').style.display = type === 'card' ? 'block' : 'none'; document.getElementById('btn-momo').classList.toggle('bg-purple-600', type === 'momo'); document.getElementById('btn-momo').classList.toggle('text-white', type === 'momo'); document.getElementById('btn-momo').classList.toggle('bg-gray-200', type !== 'momo'); document.getElementById('btn-card').classList.toggle('bg-purple-600', type === 'card'); document.getElementById('btn-card').classList.toggle('text-white', type === 'card'); document.getElementById('btn-card').classList.toggle('bg-gray-200', type !== 'card'); }
    
    window.handlePayment = (event) => {
        event.preventDefault();
        const user = appState.users[appState.currentUser];
        if (user && selectedPlan.name) {
            user.plan = selectedPlan.name;
        }
        showToast(`Payment successful! Your plan is now ${selectedPlan.name}.`);
        login(user.role, appState.currentUser);
    }
    
    const populateClassCheckboxes = (selectedClasses = []) => {
        const container = document.getElementById('class-selection-container');
        if (!container) return;
        container.innerHTML = classList.map(className => `
            <label class="flex items-center space-x-2 text-sm">
                <input type="checkbox" name="classes" value="${className}" ${selectedClasses.includes(className) ? 'checked' : ''} class="rounded">
                <span>${className}</span>
            </label>
        `).join('');
    }

    window.showCreateSchoolModal = () => {
        const user = appState.users[appState.currentUser];
        const userSchools = appState.schools.filter(s => s.createdBy === appState.currentUser);
        if (user && user.plan === 'Demo' && userSchools.length >= 1) {
            showToast('Demo plan is limited to 1 school. Please upgrade.', 'error');
            return;
        }
        document.getElementById('school-type-modal').classList.remove('hidden');
    }

    window.hideSchoolModal = () => {
        document.getElementById('school-modal').classList.add('hidden');
        document.getElementById('school-form').reset();
    }
    
    window.downloadExcelTemplate = (subjectName) => {
        const schoolSelect = document.getElementById('score-school-select');
        const classSelect = document.getElementById('score-class-select');
        
        if (!schoolSelect.value || !classSelect.value || !subjectName) {
            showToast('Please select a school, a class, and a subject first.', 'error');
            return;
        }

        const schoolName = schoolSelect.options[schoolSelect.selectedIndex].text.replace(/ /g, '_');
        const className = classSelect.value.replace(/ /g, '_');
        const formattedSubjectName = subjectName.replace(/ /g, '_');
        const fileName = `${schoolName}_${className}_${formattedSubjectName}_Template.xlsx`;
        
        const studentsInClass = appState.students.filter(s => s.schoolId === schoolSelect.value && s.className === classSelect.value);
        const ws_data = [
            ["Name", "CAT1", "CAT2", "CAT3", "CAT4", "Exam"]
        ];
        studentsInClass.forEach(student => {
            ws_data.push([student.name, "", "", "", "", ""]);
        });
        
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, 'Scores');
        XLSX.writeFile(wb, fileName);
    }

    window.downloadStudentTemplate = () => {
        const schoolSelect = document.getElementById('student-school-select');
        const classSelect = document.getElementById('student-class-select');
        
        if (!schoolSelect.value || !classSelect.value) {
            showToast('Please select a school and a class on the "Manage Students" page first.', 'error');
            return;
        }
    
        const schoolName = schoolSelect.options[schoolSelect.selectedIndex].text.replace(/ /g, '_');
        const className = classSelect.value.replace(/ /g, '_');
        const fileName = `${schoolName}_${className}_Student_Template.xlsx`;
        
        const ws_data = [
            ["Student Name"],
            ["Example Student One"],
            ["Example Student Two"]
        ];
        
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        ws['!cols'] = [ { wch: 30 } ]; // Set column width
        XLSX.utils.book_append_sheet(wb, ws, 'Students');
        XLSX.writeFile(wb, fileName);
    }
    
    window.renderRawScoreSheet = () => {
        const container = document.getElementById('raw-score-sheet-container');
        if (!container) return;

        const schoolId = document.getElementById('score-school-select').value;
        const className = document.getElementById('score-class-select').value;
        
        if (!schoolId || !className) {
            container.innerHTML = `<div class="text-center p-8 text-gray-500">Please select a school and class to view the Raw Score Sheet.</div>`;
            return;
        }

        const school = appState.schools.find(s => s.id == schoolId);
        const settings = school ? school.settings : defaultSettings;
        const classScores = appState.scores.filter(s => s.schoolId === schoolId && s.class_name === className);
        const classStudents = appState.students.filter(s => s.schoolId === schoolId && s.className === className);

        if (classStudents.length === 0) {
            container.innerHTML = `<div class="text-center p-8 text-gray-500">No students found in this class. Add students in the 'Manage Students' page first.</div>`;
            return;
        }

        const subjects = [...new Set(classScores.map(s => s.subject))];
        const studentsData = {};

        classStudents.forEach(student => {
             studentsData[student.studentIdCode] = {
                name: student.name,
                scores: {},
                total: 0,
                average: 0
            };
        });

        classScores.forEach(s => {
            if (studentsData[s.student_id_code]) {
                const processed = businessLogic.calculateScoresAndRank([s])[0];
                studentsData[s.student_id_code].scores[s.subject] = processed.total;
            }
        });

        let studentArray = Object.entries(studentsData).map(([id, data]) => {
            let total = 0;
            subjects.forEach(sub => {
                total += data.scores[sub] || 0;
            });
            data.total = total;
            data.average = subjects.length > 0 ? total / subjects.length : 0;
            return { id, ...data };
        });

        studentArray.sort((a, b) => b.average - a.average);
        
        let rank = 0, lastAvg = -1, displayRank = 0;
        studentArray.forEach(s => {
            rank++;
            if (s.average !== lastAvg) displayRank = rank;
            s.rank = displayRank;
            lastAvg = s.average;
        });

        const subjectAverages = {};
        subjects.forEach(sub => {
            const scoresForSub = classScores.filter(s => s.subject === sub);
            const total = scoresForSub.reduce((acc, curr) => acc + businessLogic.calculateScoresAndRank([curr])[0].total, 0);
            subjectAverages[sub] = scoresForSub.length > 0 ? (total / scoresForSub.length).toFixed(1) : '0.0';
        });

        const overallClassAverage = studentArray.length > 0 ? (studentArray.reduce((acc, curr) => acc + curr.average, 0) / studentArray.length).toFixed(1) : '0.0';
        
        const subjectAbbr = { 'English Language': 'ENG LAN', 'Mathematics': 'MATHS', 'Science': 'SCI', 'History': 'HISTORY', 'Creative Art': 'CA', 'Religious and Moral Education': 'RME', 'Ghanaian Language': 'G.LAN' };
        
        let headerHtml = `<div class="text-center font-bold mb-2">
            <h3 class="text-lg uppercase">${settings.school_name}</h3>
            <div class="flex justify-between items-center text-sm border-y-2 border-black p-1 my-1">
                <span>CLASS: <b class="font-black">${className}</b></span>
                <b class="text-base">RAW SCORE SHEET</b>
                <span>TERM: <b class="font-black">${settings.term}</b></span>
                <span>YEAR: <b class="font-black">${settings.year}</b></span>
                <span>NO. ON ROLL: <b class="font-black">${studentArray.length}</b></span>
            </div>
        </div>`;

        let tableHtml = `<div class="table-wrap" style="max-height: 600px;"><table class="w-full text-xs" style="border-collapse: collapse; color: black;">`;
        tableHtml += `<thead><tr class="bg-gray-200">
            <th class="border border-black p-1 text-right font-bold" colspan="2">SUBJECT AVERAGE:</th>
            ${subjects.map(sub => `<th class="border border-black p-1 font-black">${subjectAverages[sub] || 'N/A'}</th>`).join('')}
            <th class="border border-black p-1 font-bold text-center" colspan="3">CLASS AVERAGE: ${overallClassAverage}</th>
        </tr>
        <tr class="bg-gray-200 font-bold">
            <th class="border border-black p-1">SN</th>
            <th class="border border-black p-1 text-left w-1/4">NAME OF STUDENT</th>
            ${subjects.map(sub => `<th class="border border-black p-1">${subjectAbbr[sub] || sub}</th>`).join('')}
            <th class="border border-black p-1">TOTAL</th>
            <th class="border border-black p-1">Average</th>
            <th class="border border-black p-1">Position</th>
        </tr></thead>`;
        tableHtml += `<tbody>`;
        studentArray.forEach((student, index) => {
            tableHtml += `<tr>
                <td class="border border-black p-1 text-center">${index + 1}</td>
                <td class="border border-black p-1 text-left">${student.name}</td>
                ${subjects.map(sub => `<td class="border border-black p-1 text-center">${(student.scores[sub] || 0).toFixed(2)}</td>`).join('')}
                <td class="border border-black p-1 text-center font-bold">${student.total.toFixed(2)}</td>
                <td class="border border-black p-1 text-center font-bold">${student.average.toFixed(2)}</td>
                <td class="border border-black p-1 text-center font-bold">${student.rank}${['st','nd','rd'][((student.rank+90)%100-10)%10-1]||'th'}</td>
            </tr>`;
        });
        tableHtml += `</tbody></table></div>`;

        container.innerHTML = headerHtml + tableHtml;
    }

    window.printRawScoreSheet = () => {
        const container = document.getElementById('raw-score-sheet-container');
        if (container.children.length > 1) {
            window.print();
        } else {
            showToast('Nothing to print. Please select a class first.', 'info');
        }
    }
    
    window.downloadRawScoreAsPDF = () => {
        const container = document.getElementById('raw-score-sheet-container');
        if (!container || container.children.length <= 1) {
            showToast('Nothing to download. Please select a class first.', 'info');
            return;
        }

        const schoolSelect = document.getElementById('score-school-select');
        const classSelect = document.getElementById('score-class-select');
        
        const schoolName = schoolSelect.options[schoolSelect.selectedIndex].text.replace(/ /g, '_');
        const className = classSelect.value.replace(/ /g, '_');
        const fileName = `Raw_Scores_${schoolName}_${className}.pdf`;

        const opt = {
            margin:       0.5,
            filename:     fileName,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2 },
            jsPDF:        { unit: 'in', format: 'letter', orientation: 'landscape' }
        };

        showToast('Generating PDF... Please wait.', 'info');
        html2pdf().from(container).set(opt).save();
    }


    window.deleteScore = (scoreId) => {
        showConfirmationModal(
            'Are you sure you want to delete this record?',
            () => {
                const scoreIndex = appState.scores.findIndex(s => s.id == scoreId);
                if (scoreIndex > -1) {
                    appState.scores.splice(scoreIndex, 1);
                    clearAssessmentForm();
                    renderRawScoreSheet();
                    renderScoresSummary();
                    showToast('Record deleted successfully.');
                }
            }
        );
    }

    window.handleCreateSchool = (event) => {
        event.preventDefault();
        const form = event.target;
        const selectedClasses = Array.from(form.elements.classes).filter(cb => cb.checked).map(cb => cb.value);

        const user = appState.users[appState.currentUser];
        if (user && user.plan === 'Demo' && selectedClasses.length > 1) {
            showToast('Demo plan is limited to 1 class. Please upgrade to add more classes.', 'error');
            return;
        }

        const school = {
            id: Date.now(),
            name: form.elements.name.value,
            address: form.elements.address.value,
            classes: selectedClasses,
            type: newSchoolType, // Add the type here
            settings: { ...defaultSettings, school_name: form.elements.name.value, postal_address: form.elements.address.value },
            createdBy: appState.currentUser
        };
        appState.schools.push(school);
        hideSchoolModal();
        renderSchoolList();
        showToast(`School "${school.name}" created!`);
        newSchoolType = null; // Reset temp variable
    }

     window.editSchool = (schoolId) => {
        const school = appState.schools.find(s => s.id == schoolId);
        if (!school) return;

        const form = document.getElementById('school-form');
        form.reset();

        document.getElementById('school-modal-title').textContent = `Edit ${school.type || ''} School`;
        document.getElementById('school-form-submit-btn').textContent = 'Update School';
        
        form.elements.name.value = school.name;
        form.elements.address.value = school.address;
        populateClassCheckboxes(school.classes);
        form.elements.schoolId.value = school.id;

        document.getElementById('school-modal').classList.remove('hidden');
        form.onsubmit = handleUpdateSchool;
    }

    window.handleUpdateSchool = (event) => {
        event.preventDefault();
        const form = event.target;
        const schoolId = form.elements.schoolId.value;
        const schoolIndex = appState.schools.findIndex(s => s.id == schoolId);
        const selectedClasses = Array.from(form.elements.classes).filter(cb => cb.checked).map(cb => cb.value);

        const user = appState.users[appState.currentUser];
        if (user && user.plan === 'Demo' && selectedClasses.length > 1) {
            showToast('Demo plan is limited to 1 class. Please upgrade to add more classes.', 'error');
            return;
        }

        if (schoolIndex > -1) {
            appState.schools[schoolIndex].name = form.elements.name.value;
            appState.schools[schoolIndex].address = form.elements.address.value;
            appState.schools[schoolIndex].classes = selectedClasses;
            
            appState.schools[schoolIndex].settings.school_name = form.elements.name.value;
            appState.schools[schoolIndex].settings.postal_address = form.elements.address.value;

            hideSchoolModal();
            renderSchoolList();
            showToast('School updated successfully!');
        }
    }

    window.deleteSchool = (schoolId) => {
        showConfirmationModal(
            'Are you sure you want to delete this school and all its associated data (including students and scores)? This cannot be undone.',
            () => {
                const schoolIndex = appState.schools.findIndex(s => s.id == schoolId);
                if (schoolIndex > -1) {
                    appState.schools.splice(schoolIndex, 1);
                    appState.students = appState.students.filter(student => student.schoolId != schoolId);
                    appState.scores = appState.scores.filter(score => score.schoolId != schoolId);
                    renderSchoolList();
                    showToast('School deleted successfully.');
                }
            }
        );
    }

    // --- Student Management Functions ---
    window.showStudentModal = (studentId = null) => {
        const modal = document.getElementById('student-modal');
        const form = document.getElementById('student-form');
        const title = document.getElementById('student-modal-title');
        const schoolSelect = form.elements.schoolId;
        const classSelect = form.elements.className;
        const picPreview = document.getElementById('student-picture-preview');
        const picField = document.getElementById('student-picture-upload-field');

        form.reset();
        picPreview.classList.add('hidden');
        picPreview.src = '';
        
        schoolSelect.innerHTML = '<option value="">-- Select School --</option>' + appState.schools.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

        schoolSelect.onchange = () => {
            const school = appState.schools.find(s => s.id == schoolSelect.value);
            if (school) {
                classSelect.innerHTML = '<option value="">-- Select Class --</option>' + school.classes.map(c => `<option value="${c}">${c}</option>`).join('');
                classSelect.disabled = false;
            } else {
                classSelect.innerHTML = '<option value="">-- Select School First --</option>';
                classSelect.disabled = true;
            }
        };

        const user = appState.users[appState.currentUser];
        if (user && user.plan !== 'Pro Plus') {
            picField.classList.add('opacity-50');
            picField.querySelector('input').disabled = true;
             if (!picField.querySelector('p')) {
                const proNotice = document.createElement('p');
                proNotice.className = 'text-xs text-purple-600 mt-1';
                proNotice.textContent = 'Upgrade to Pro Plus to add student pictures.';
                picField.appendChild(proNotice);
            }
        } else {
             picField.classList.remove('opacity-50');
            picField.querySelector('input').disabled = false;
            const notice = picField.querySelector('p');
            if(notice) notice.remove();
        }

        if (studentId) {
            title.textContent = 'Edit Student';
            const student = appState.students.find(s => s.id == studentId);
            form.elements.studentId.value = student.id;
            form.elements.name.value = student.name;
            schoolSelect.value = student.schoolId;
            schoolSelect.dispatchEvent(new Event('change'));
            classSelect.value = student.className;
            if (student.pictureUrl) {
                picPreview.src = student.pictureUrl;
                picPreview.classList.remove('hidden');
            }

        } else {
            title.textContent = 'Add New Student';
            const currentSchool = document.getElementById('student-school-select').value;
            const currentClass = document.getElementById('student-class-select').value;
            if(currentSchool){
                schoolSelect.value = currentSchool;
                schoolSelect.dispatchEvent(new Event('change'));
                if(currentClass) classSelect.value = currentClass;
            }
        }
        
        form.onsubmit = handleSaveStudent;
        modal.classList.remove('hidden');
    }

    window.hideStudentModal = () => {
        document.getElementById('student-modal').classList.add('hidden');
    }

    window.handleSaveStudent = async (event) => {
        event.preventDefault();
        const form = event.target;
        const studentId = form.elements.studentId.value;
        const pictureFile = form.elements.pictureFile.files[0];
        
        let pictureUrl = null;
        if (pictureFile) {
            const fd = new FormData();
            fd.append('file', pictureFile);
            const res = await apiCall('upload.php', 'POST', fd);
            pictureUrl = res.filePath;
        }

        if (studentId) {
            const studentIndex = appState.students.findIndex(s => s.id == studentId);
            if (studentIndex > -1) {
                const oldName = appState.students[studentIndex].name;
                appState.students[studentIndex].name = form.elements.name.value;
                appState.students[studentIndex].schoolId = form.elements.schoolId.value;
                appState.students[studentIndex].className = form.elements.className.value;
                if(pictureUrl) appState.students[studentIndex].pictureUrl = pictureUrl;
                
                if(oldName !== form.elements.name.value){
                    appState.scores.forEach(score => {
                        if (score.student_id_code === appState.students[studentIndex].studentIdCode) {
                            score.name = form.elements.name.value;
                        }
                    });
                }
                showToast('Student updated successfully!');
            }
        } else {
            const user = appState.users[appState.currentUser];
            const userStudents = appState.students.filter(s => s.createdBy === appState.currentUser);
            if (user && user.plan === 'Demo' && userStudents.length >= 1) {
                showToast('Demo plan is limited to 1 student. Please upgrade.', 'error');
                return;
            }

            const schoolIdForNewStudent = form.elements.schoolId.value;
            const classNameForNewStudent = form.elements.className.value;
            const studentsInClass = appState.students.filter(s => s.schoolId === schoolIdForNewStudent && s.className === classNameForNewStudent);
            const maxId = studentsInClass.reduce((max, s) => Math.max(max, parseInt(s.studentIdCode.replace('SN','')) || 0), 0);
            const newStudentIdCode = 'SN' + (maxId + 1);
            const newStudent = {
                id: Date.now(),
                studentIdCode: newStudentIdCode,
                name: form.elements.name.value,
                schoolId: form.elements.schoolId.value,
                className: form.elements.className.value,
                pictureUrl: pictureUrl,
                createdBy: appState.currentUser
            };
            appState.students.push(newStudent);
            showToast('Student added successfully!');
        }

        hideStudentModal();
        renderStudentList();
    }

    window.deleteStudent = (studentId) => {
        showConfirmationModal('Are you sure you want to delete this student and all their scores? This cannot be undone.', () => {
            const studentIndex = appState.students.findIndex(s => s.id == studentId);
            if(studentIndex > -1) {
                const studentIdCodeToDelete = appState.students[studentIndex].studentIdCode;
                appState.students.splice(studentIndex, 1);
                appState.scores = appState.scores.filter(s => s.student_id_code !== studentIdCodeToDelete);
                renderStudentList();
                showToast('Student deleted successfully.');
            }
        });
    }

    window.handleBulkAddStudents = (event) => {
        event.preventDefault();
        const form = event.target;
        const namesText = form.elements.studentNames.value;
        const schoolId = document.getElementById('student-school-select').value;
        const className = document.getElementById('student-class-select').value;

        if (!schoolId || !className) {
            showToast('Please select a school and class first.', 'error');
            return;
        }

        const names = namesText.split('\n').map(name => name.trim()).filter(name => name);
        if (names.length === 0) {
            showToast('Please enter at least one student name.', 'error');
            return;
        }

        const studentsInClass = appState.students.filter(s => s.schoolId === schoolId && s.className === className);
        let maxId = studentsInClass.reduce((max, s) => Math.max(max, parseInt(s.studentIdCode.replace('SN','')) || 0), 0);
        
        names.forEach(name => {
            maxId++;
            const newStudentIdCode = 'SN' + maxId;
            const newStudent = {
                id: Date.now() + Math.random(),
                studentIdCode: newStudentIdCode,
                name: name,
                schoolId: schoolId,
                className: className,
                pictureUrl: null,
                createdBy: appState.currentUser
            };
            appState.students.push(newStudent);
        });

        hideBulkStudentModal();
        renderStudentList();
        showToast(`${names.length} students added successfully!`);
    };

    window.handleBulkStudentUpload = (event) => {
        event.preventDefault();
        const form = event.target;
        const fileInput = form.elements.student_excel_file;
        const file = fileInput.files[0];
        const statusDiv = form.querySelector('.upload-status');
        
        const schoolId = document.getElementById('student-school-select').value;
        const className = document.getElementById('student-class-select').value;
    
        if (!schoolId || !className) {
            showToast('Please select a school and class first.', 'error');
            return;
        }
    
        if (!file) {
            statusDiv.textContent = 'Please select a file.';
            return;
        }

        const schoolName = document.getElementById('student-school-select').options[document.getElementById('student-school-select').selectedIndex].text.replace(/ /g, '_');
        const formattedClassName = className.replace(/ /g, '_');
        const expectedFileName = `${schoolName}_${formattedClassName}_Student_Template.xlsx`;
        
        if (file.name !== expectedFileName) {
            statusDiv.innerHTML = `<span class="text-red-600">Error: Incorrect file. Please upload "${expectedFileName}".</span>`;
            fileInput.value = '';
            return;
        }

        statusDiv.textContent = 'Processing...';
    
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);
    
                if (json.length === 0) {
                    statusDiv.textContent = 'Error: Excel sheet is empty or has an invalid format.';
                    return;
                }

                const studentsInClass = appState.students.filter(s => s.schoolId === schoolId && s.className === className);
                let maxId = studentsInClass.reduce((max, s) => Math.max(max, parseInt(s.studentIdCode.replace('SN','')) || 0), 0);
                let addedCount = 0;

                json.forEach(row => {
                    const name = row['Student Name'];
                    if (name && String(name).trim() && !String(name).trim().toLowerCase().includes("example student")) {
                        maxId++;
                        const newStudentIdCode = 'SN' + maxId;
                        const newStudent = {
                            id: Date.now() + Math.random(),
                            studentIdCode: newStudentIdCode,
                            name: String(name).trim(),
                            schoolId: schoolId,
                            className: className,
                            pictureUrl: null,
                            createdBy: appState.currentUser
                        };
                        appState.students.push(newStudent);
                        addedCount++;
                    }
                });

                if (addedCount > 0) {
                    hideBulkStudentModal();
                    renderStudentList();
                    showToast(`${addedCount} students added successfully!`);
                    form.reset();
                    statusDiv.textContent = '';
                } else {
                    statusDiv.textContent = 'No valid new student names found in the file.';
                }
    
            } catch (error) {
                statusDiv.textContent = 'Error processing file. See console for details.';
                console.error('Error processing student upload:', error);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    window.handleUpdateProfile = async (event) => {
        event.preventDefault();
        const form = event.target;
        const user = appState.users[appState.currentUser];
        if (!user) return;

        const pictureFile = form.elements.profile_picture_file.files[0];

        try {
            if (pictureFile) {
                const fd = new FormData();
                fd.append('file', pictureFile);
                const res = await apiCall('upload.php', 'POST', fd);
                user.pictureUrl = res.filePath;
                document.getElementById('profile-pic-preview').src = res.filePath;
            }

            user.name = form.elements.fullName.value;
            showToast('Profile updated successfully!');
        } catch (error) {
            console.error('Failed to update profile:', error);
            showToast('Error updating profile.', 'error');
        }
    }

    window.handleChangePassword = (event) => {
        event.preventDefault();
        const form = event.target;
        const newPassword = form.elements.new_password.value;
        const confirmPassword = form.elements.confirm_password.value;

        if (!newPassword) {
            showToast('Please enter a new password.', 'error');
            return;
        }

        if (newPassword !== confirmPassword) {
            showToast('Passwords do not match.', 'error');
            return;
        }
        showToast('Password updated successfully!');
        form.reset();
    }

    window.handleDeleteAccount = () => {
        showConfirmationModal(
            'Are you sure you want to delete your account? This will permanently remove all your data, including schools, students, and scores. This action cannot be undone.',
            () => {
                const email = appState.currentUser;
                if (appState.users[email]) {
                    const userSchools = appState.schools.filter(school => school.createdBy === email);
                    const schoolIdsToDelete = userSchools.map(s => s.id);

                    appState.scores = appState.scores.filter(score => !schoolIdsToDelete.includes(parseInt(score.schoolId)));
                    appState.students = appState.students.filter(student => !schoolIdsToDelete.includes(parseInt(student.schoolId)));
                    appState.schools = appState.schools.filter(school => school.createdBy !== email);
                    delete appState.users[email];
                    
                    showToast('Account deleted successfully. Logging out.');
                    setTimeout(() => {
                        logout();
                    }, 1500);
                }
            }
        );
    }
    
    // --- [Utility Functions: Modals & Toasts] ---
    function formatDateTime(isoString) {
        if (!isoString) return 'N/A';
        try {
            const date = new Date(isoString);
            if (isNaN(date.getTime())) return 'Invalid Date';
            return date.toLocaleString('en-GB', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true });
        } catch (e) {
            return 'Invalid Date';
        }
    }
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast-notification');
        const toastMessage = document.getElementById('toast-message');
        
        toastMessage.textContent = message;
        toast.className = 'fixed bottom-5 right-5 text-white py-3 px-5 rounded-lg shadow-lg transition-opacity duration-300'; // Reset classes
        if (type === 'error') {
            toast.classList.add('bg-red-500');
        } else if (type === 'info') {
            toast.classList.add('bg-blue-500');
        }
        else {
            toast.classList.add('bg-green-500');
        }
        
        toast.classList.remove('hidden');
        setTimeout(() => {
            toast.classList.add('opacity-0');
        }, 3000);
        setTimeout(() => {
            toast.classList.add('hidden');
            toast.classList.remove('opacity-0');
        }, 3500);
    }

    function showConfirmationModal(message, onConfirm) {
        const modal = document.getElementById('confirmation-modal');
        document.getElementById('confirmation-message').textContent = message;

        const confirmBtn = document.getElementById('confirm-action-btn');
        const cancelBtn = document.getElementById('confirm-cancel-btn');

        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

        newConfirmBtn.onclick = () => {
            onConfirm();
            hideConfirmationModal();
        };

        cancelBtn.onclick = hideConfirmationModal;

        modal.classList.remove('hidden');
    }

    function hideConfirmationModal() {
        document.getElementById('confirmation-modal').classList.add('hidden');
    }

    window.hideSchoolTypeModal = () => {
        document.getElementById('school-type-modal').classList.add('hidden');
    }

    window.showSchoolForm = (schoolType) => {
        newSchoolType = schoolType; // Store the selected type
        hideSchoolTypeModal(); // Hide the type selection modal

        // Now, show the actual form modal
        const form = document.getElementById('school-form');
        form.reset();
        document.getElementById('school-modal-title').textContent = `Create New ${schoolType} School`;
        form.elements.schoolId.value = '';
        document.getElementById('school-form-submit-btn').textContent = 'Save School';
        populateClassCheckboxes();
        document.getElementById('school-modal').classList.remove('hidden');
        form.onsubmit = handleCreateSchool;
    }

    // New function to render announcements on the public homepage
    function renderPublicAnnouncements() {
        const listDiv = document.getElementById('public-announcements-list');
        if (!listDiv) return;

        // Show only the latest 2 announcements
        const recentAnnouncements = appState.announcements.slice(0, 2);
        
        if (recentAnnouncements.length === 0) {
            listDiv.innerHTML = '<p class="text-gray-500 col-span-2 text-center">No recent updates to show. Check back soon!</p>';
            return;
        }

        const colorMap = { info: 'blue', success: 'green', warning: 'yellow', error: 'red' };
        listDiv.innerHTML = recentAnnouncements.map(a => `
            <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-${colorMap[a.type]}-500 transition transform hover:-translate-y-1">
                <h3 class="text-xl font-bold mb-2 text-gray-800">${a.title}</h3>
                <p class="text-gray-600">${a.content}</p>
            </div>
        `).join('');
    }


    // Add event listener to initialize public page content when the DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        renderPublicAnnouncements();
    });

</script>

</body>
</html>